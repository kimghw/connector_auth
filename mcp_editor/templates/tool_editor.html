<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Definitions Editor</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/tool_editor.css">
</head>
<body>
<div class="container">
        <div class="header">
            <h1>
                <img class="brand-logo" src="/static/brands/logo.jpg" alt="MCP Logo" title="MCP Logo" />
                <span>MCP Tool <span class="gradient-text">Editor</span></span>
            </h1>
            <div class="header-buttons">
                <button class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_RELOAD" onclick="loadTools()" data-tooltip="ðŸ“‚ Load: tool_definitions.py&#10;ðŸ“‚ Load: tool_internal_args.json&#10;&#10;Refresh tool list from server files">
                    <span class="material-icons">refresh</span>
                </button>
                <button class="btn btn-secondary btn-tooltip debug-index-toggle btn-icon-only" data-debug-id="BTN_IDS" id="debugIndexToggle" onclick="toggleDebugIndexes()" data-tooltip="Show IDs on buttons/fields and hover to see inline handlers" aria-pressed="false">
                    <span class="material-icons">push_pin</span>
                    <span class="debug-dup-badge" id="debugDuplicateBadge" aria-hidden="true"></span>
                </button>
                <button class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_BACKUPS" onclick="showBackups()" data-tooltip="Manage backups">
                    <span class="material-icons">inventory_2</span>
                </button>
                <button class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_HELP" onclick="openHelpModal()" data-tooltip="View diagrams and documentation&#10;Tool/Handler structure&#10;Add Property flow">
                    <span class="material-icons">help_outline</span>
                </button>
                <a href="/docs" target="_blank" class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_DOCS" data-tooltip="ðŸ“Š ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ëž¨&#10;ðŸ”„ í•¸ë“¤ëŸ¬ ì²˜ë¦¬ ê°€ì´ë“œ&#10;ðŸ“‹ íŒŒë¼ë¯¸í„° ë³‘í•© ì²´ê³„&#10;&#10;Open documentation viewer">
                    <span class="material-icons">article</span>
                </a>
                <button class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_VALIDATE" onclick="validateTools()" data-tooltip="Validate tool definitions">
                    <span class="material-icons">check_circle</span>
                </button>
                <button class="btn btn-secondary btn-tooltip btn-icon-only" data-debug-id="BTN_SAVE" onclick="saveTools()" data-tooltip="ðŸ’¾ Save: tool_definitions.py&#10;ðŸ’¾ Save: tool_definition_templates.py&#10;ðŸ’¾ Save: tool_internal_args.json&#10;&#10;Save all changes to disk">
                    <span class="material-icons">save</span>
                </button>
                <button class="btn btn-important btn-tooltip" data-debug-id="BTN_GENERATE" onclick="saveTools(); openGeneratorModal()" data-tooltip="âš™ï¸ Input: tool_definitions.py&#10;ðŸ“„ Template: *_server_template.jinja2&#10;ðŸš€ Output: server.py&#10;&#10;Generate MCP server from template">
                    <span class="material-icons">auto_fix_high</span> Generate Server
                </button>
                <button class="btn btn-primary btn-tooltip btn-expandable" data-debug-id="BTN_NEW_PROJECT" onclick="openCreateProjectModal()" data-tooltip="ðŸš€ Create new MCP server project&#10;ðŸ“ Complete folder structure&#10;ðŸ“ Ready-to-use templates&#10;&#10;Create a new MCP service from scratch">
                    <span class="material-icons">add_circle</span><span class="btn-text">New Project</span>
                </button>
                <button class="btn btn-tooltip btn-expandable" data-debug-id="BTN_DERIVE_SERVER" onclick="showDeriveModal(window.currentProfile || 'outlook')" style="background: linear-gradient(135deg, #a855f7, #7c3aed); color: white;" data-tooltip="ðŸ”€ í˜„ìž¬ í”„ë¡œí•„ì—ì„œ íŒŒìƒ ì„œë²„ ìƒì„±&#10;ðŸ“ ë™ì¼ ì„œë¹„ìŠ¤ ìž¬ì‚¬ìš©&#10;ðŸ”§ ë„êµ¬ë§Œ ë¶„ë¦¬ ê´€ë¦¬&#10;&#10;Create derived server from current profile">
                    <span class="material-icons">call_split</span><span class="btn-text">Derive</span>
                </button>
                <button class="btn btn-tooltip btn-expandable" data-debug-id="BTN_MERGE_SERVERS" onclick="showMergeServersModal()" style="background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white;" data-tooltip="ðŸ”— ì—¬ëŸ¬ MCP ì„œë²„ ë³‘í•©&#10;ðŸ“ outlook + calendar â†’ ms365&#10;âš™ï¸ ë„êµ¬ ì¶©ëŒ ìžë™ ì²˜ë¦¬&#10;&#10;Merge multiple MCP servers into one">
                    <span class="material-icons">merge_type</span><span class="btn-text">Merge</span>
                </button>
                <button class="btn btn-tooltip btn-expandable" data-debug-id="BTN_DELETE_SERVER" onclick="showDeleteServerModal(window.currentProfile || '')" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;" data-tooltip="ðŸ—‘ï¸ MCP ì„œë²„ ì‚­ì œ&#10;ðŸ“ ì›¹ì—ë””í„° ì •ì˜ ì‚­ì œ&#10;âš ï¸ ì„œë¹„ìŠ¤ ì½”ë“œëŠ” ìœ ì§€&#10;&#10;Delete MCP server (keeps service code)">
                    <span class="material-icons">delete_forever</span><span class="btn-text">Delete</span>
                </button>
            </div>
        </div>
        <div id="profileTabs" data-debug-id="AREA_PROFILE_TABS" style="display: flex; justify-content: flex-start; gap: 8px; padding: 10px 20px; background: #f7f7f7; border-bottom: 1px solid #e5e5e5;">
            <!-- Profile tabs will be rendered here -->
        </div>
        <div id="templateSelector" data-debug-id="AREA_TEMPLATE_SELECTOR" style="display: flex; gap: 12px; align-items: center; padding: 8px 20px; background: #fff9e6; border-bottom: 1px solid #e5e5e5;">
            <label style="font-size: 13px; font-weight: 500; color: #666; white-space: nowrap;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">description</span>
                Load Template:
            </label>
            <select id="templateSource" class="form-control" data-debug-id="FIELD_TEMPLATE_SOURCE" style="flex: 1; max-width: 400px; padding: 6px 12px; font-size: 13px;">
                <option value="">-- Current Template --</option>
            </select>
            <button class="btn btn-secondary btn-sm" data-debug-id="BTN_TEMPLATE_LOAD" onclick="loadFromSelectedTemplate()" title="Load tools from selected template">
                <span class="material-icons" style="font-size: 14px;">file_download</span> Load
            </button>
            <span id="templateLoadStatus" style="font-size: 12px; color: #666;"></span>
            <span style="font-size: 11px; color: #999; margin-left: auto;">
                * Save will update: <strong id="saveTargetLabel">current profile</strong>
            </span>
        </div>

        <div class="main-content" data-debug-id="AREA_MAIN_CONTENT">
            <div class="sidebar" data-debug-id="AREA_SIDEBAR">
                <div class="tool-list" data-debug-id="AREA_TOOL_LIST">
                    <!-- MCP Server Controller -->
                    <div class="mcp-controller" data-debug-id="AREA_MCP_CONTROLLER" style="margin-bottom: 20px; padding: 16px; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div data-debug-id="BTN_SERVER_DASHBOARD" onclick="openServerDashboard()" title="ì„œë²„ ëŒ€ì‹œë³´ë“œ ì—´ê¸°" style="width: 40px; height: 40px; border-radius: 10px; background: white; display: flex; align-items: center; justify-content: center; margin-right: 12px; padding: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" onmouseover="this.style.borderColor='#667eea'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
                                <img src="/static/brands/mcp.svg" alt="MCP" style="width: 100%; height: 100%; object-fit: contain;">
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1d1d1f;">MCP Server Controller</h3>
                                <div id="serverStatus" data-debug-id="LABEL_SERVER_STATUS" style="display: flex; align-items: center; font-size: 12px; margin-top: 2px;">
                                    <span class="status-indicator" id="statusIndicator" style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #86868b; margin-right: 6px;"></span>
                                    <span id="statusText" style="color: #86868b; font-weight: 500;">Checking...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Profile & Protocol Selectors -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: #86868b; display: block; margin-bottom: 4px;">Profile:</label>
                                <select id="serverProfileSelect" data-debug-id="SELECT_SERVER_PROFILE" class="form-control" onchange="onServerProfileChange()" style="width: 100%; padding: 6px 10px; font-size: 12px; border: 1px solid #d2d2d7; border-radius: 8px; background: white;">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; color: #86868b; display: block; margin-bottom: 4px;">Protocol:</label>
                                <select id="serverProtocolSelect" data-debug-id="SELECT_SERVER_PROTOCOL" class="form-control" onchange="onServerProtocolChange()" style="width: 100%; padding: 6px 10px; font-size: 12px; border: 1px solid #d2d2d7; border-radius: 8px; background: white;">
                                    <option value="stream">STREAM</option>
                                    <option value="rest">REST</option>
                                    <option value="stdio">STDIO</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <button class="btn btn-sm" data-debug-id="BTN_SERVER_START" id="btnStart" onclick="startServer()" title="Start Server" style="background: #e8f5e9; color: #2e7d32; border: none; padding: 10px; border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons" style="font-size: 24px;">play_arrow</span>
                            </button>
                            <button class="btn btn-sm" data-debug-id="BTN_SERVER_STOP" id="btnStop" onclick="stopServer()" title="Stop Server" style="background: #ffebee; color: #c62828; border: none; padding: 10px; border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons" style="font-size: 24px;">stop</span>
                            </button>
                            <button class="btn btn-sm" data-debug-id="BTN_SERVER_RESTART" id="btnRestart" onclick="restartServer()" title="Restart Server" style="background: #fff3e0; color: #ef6c00; border: none; padding: 10px; border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons" style="font-size: 24px;">refresh</span>
                            </button>
                        </div>

                        <div id="serverInfo" data-debug-id="LABEL_SERVER_INFO" style="font-size: 11px; color: #86868b; background: #f5f5f7; padding: 8px 12px; border-radius: 8px; display: flex; justify-content: space-between;">
                            <div id="profileInfo">
                                <span style="font-weight: 600;">Profile:</span> <span id="profileValue">default</span>
                            </div>
                            <div id="pidInfo" style="display: none;">
                                <span style="font-weight: 600;">PID:</span> <span id="pidValue">-</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px;">
                        <button class="add-button" data-debug-id="BTN_ADD_TOOL" onclick="addNewTool()" style="flex: 1; padding: 8px 12px; font-size: 12px;">
                            Add New Tool
                        </button>
                        <button class="add-button" data-debug-id="BTN_MOVE_TOOLS" onclick="openMoveToolsDialog()" style="flex: 1; padding: 8px 12px; font-size: 12px; background: #f3e8ff;">
                            Move Tools
                        </button>
                    </div>
                    <div id="toolList" style="margin-top: 15px;">
                        <!-- Tool items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="editor-area" data-debug-id="AREA_EDITOR">
                <div id="editorContent">
                    <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                        Select a tool from the left sidebar to edit
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nested Properties Modal -->
    <div id="nestedPropertiesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="nestedModalTitle">Edit Nested Properties</h2>
                <button class="btn btn-icon" data-debug-id="BTN_NESTED_CLOSE" onclick="closeModal('nestedPropertiesModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="nestedPropertiesEditor">
                    <!-- Nested properties editor will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-debug-id="BTN_NESTED_SAVE" onclick="saveNestedProperties()">Save Properties</button>
                <button class="btn btn-secondary" data-debug-id="BTN_NESTED_CANCEL" onclick="closeModal('nestedPropertiesModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- BaseModel Selector Modal -->
    <div id="baseModelModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Select BaseModel to Import</h2>
                <button class="btn btn-icon" data-debug-id="BTN_BASEMODEL_CLOSE" onclick="closeModal('baseModelModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="baseModelList" style="max-height: 500px; overflow-y: auto;">
                    <!-- BaseModel list will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-debug-id="BTN_BASEMODEL_CANCEL" onclick="closeModal('baseModelModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Nested Graph Types Modal -->
    <div id="nestedGraphTypesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Nested Properties</h2>
                <button class="btn btn-icon" data-debug-id="BTN_NESTED_TYPES_CLOSE" onclick="closeModal('nestedGraphTypesModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Type (from outlook_types.py)</label>
                    <select id="nestedGraphTypeClass" data-debug-id="FIELD_NESTED_GRAPH_TYPE" onchange="handleNestedGraphClassChange()" class="form-control">
                        <option value="">-- Select Type --</option>
                        <option value="FilterParams">FilterParams (Filter criteria)</option>
                        <option value="ExcludeParams">ExcludeParams (Exclusion criteria)</option>
                        <option value="SelectParams">SelectParams (Field selection)</option>
                    </select>
                </div>
                <div class="form-group" id="nestedPropertySelectionDiv" style="display: none;">
                    <label>Select Properties to Add</label>
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;">
                        <div id="nestedPropertyCheckboxList">
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-secondary" data-debug-id="BTN_NESTED_SELECT_ALL" onclick="selectAllNestedProperties(true)">Select All</button>
                        <button type="button" class="btn btn-sm btn-secondary" data-debug-id="BTN_NESTED_DESELECT_ALL" onclick="selectAllNestedProperties(false)">Deselect All</button>
                        <button type="button" class="btn btn-sm btn-secondary" data-debug-id="BTN_NESTED_ALL_REQUIRED" onclick="toggleAllNestedRequired(true)">All Required</button>
                        <button type="button" class="btn btn-sm btn-secondary" data-debug-id="BTN_NESTED_ALL_OPTIONAL" onclick="toggleAllNestedRequired(false)">All Optional</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-debug-id="BTN_NESTED_TYPES_ADD" onclick="confirmAddNestedGraphProperties()">Add Selected</button>
                <button class="btn btn-secondary" data-debug-id="BTN_NESTED_TYPES_CANCEL" onclick="closeModal('nestedGraphTypesModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Backup Management</h2>
                <button class="btn btn-icon" data-debug-id="BTN_BACKUP_CLOSE_X" onclick="closeModal('backupModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="backupList" class="backup-list">
                    <!-- Backup items will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-debug-id="BTN_BACKUP_CLOSE" onclick="closeModal('backupModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create New MCP Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Create New MCP Project</h2>
                <button class="btn btn-icon" data-debug-id="BTN_PROJECT_CLOSE" onclick="closeModal('createProjectModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <!-- Project Type Selection -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">Project Type</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="projectType" value="new" checked onchange="toggleReuseOptions()">
                            Create from scratch
                        </label>
                        <label style="font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="projectType" value="reuse" onchange="toggleReuseOptions()">
                            Reuse existing service
                        </label>
                    </div>
                </div>

                <!-- New Project Options (shown by default) -->
                <div id="newProjectOptions">
                    <div class="form-group">
                        <label>Service Name <span style="color: red;">*</span></label>
                        <input id="projectServiceName" class="form-control" data-debug-id="FIELD_PROJECT_NAME" placeholder="e.g., calendar, weather, database" required>
                        <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                            Only letters, numbers, and underscores allowed. Will create mcp_{service_name} folder.
                        </p>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input id="projectDescription" class="form-control" data-debug-id="FIELD_PROJECT_DESC" placeholder="Brief description of the service">
                    </div>
                    <div class="form-group">
                        <label>Author</label>
                        <input id="projectAuthor" class="form-control" data-debug-id="FIELD_PROJECT_AUTHOR" placeholder="Your name (optional)">
                    </div>
                    <div class="form-group">
                        <label>
                            <input id="projectIncludeTypes" type="checkbox" data-debug-id="FIELD_PROJECT_INCLUDE_TYPES" checked>
                            Include type definitions file (*_types.py)
                        </label>
                    </div>
                </div>

                <!-- Reuse Options (hidden by default) -->
                <div id="reuseOptions" style="display: none;">
                    <div class="form-group">
                        <label>Existing Service <span style="color: red;">*</span></label>
                        <select id="projectReuseService" class="form-control">
                            <option value="">-- Select a service to reuse --</option>
                        </select>
                        <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                            The new profile will share the same service code but can have different tools.
                        </p>
                    </div>
                    <div class="form-group">
                        <label>New Profile Name <span style="color: red;">*</span></label>
                        <input id="projectNewProfileName" class="form-control" placeholder="e.g., outlook_read, calendar_readonly">
                        <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                            Only letters, numbers, and underscores allowed. Creates mcp_{profile_name} folder.
                        </p>
                    </div>
                </div>

                <!-- Common Port Setting -->
                <div class="form-group">
                    <label>Port</label>
                    <input id="projectPort" type="number" class="form-control" data-debug-id="FIELD_PROJECT_PORT" value="8080" min="1024" max="65535">
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Server port number (1024-65535)
                    </p>
                </div>

                <div id="createProjectResult" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-debug-id="BTN_PROJECT_CANCEL" onclick="closeModal('createProjectModal')">Cancel</button>
                <button class="btn btn-primary" data-debug-id="BTN_PROJECT_CREATE" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Merge Servers Modal -->
    <div id="mergeServersModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons" style="color: #0ea5e9;">merge_type</span>
                    Merge MCP Servers
                </h2>
                <button class="btn btn-icon" data-debug-id="BTN_MERGE_CLOSE" onclick="closeModal('mergeServersModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Merged Server Name <span style="color: red;">*</span></label>
                    <input id="mergeServerName" class="form-control" data-debug-id="FIELD_MERGE_NAME" placeholder="e.g., ms365, productivity, unified">
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Name for the merged server. Will create mcp_{name} folder.
                    </p>
                </div>
                <div class="form-group">
                    <label>Source Profiles <span style="color: red;">*</span></label>
                    <div id="mergeSourceProfiles" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
                        <!-- Profile checkboxes will be populated here -->
                    </div>
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Select 2 or more profiles to merge. Tools from all selected profiles will be combined.
                    </p>
                </div>
                <div class="form-group">
                    <label>Port</label>
                    <input id="mergeServerPort" type="number" class="form-control" data-debug-id="FIELD_MERGE_PORT" value="8090" min="1024" max="65535">
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Server port number (1024-65535)
                    </p>
                </div>
                <div class="form-group">
                    <label>Tool Name Prefix Mode</label>
                    <select id="mergePrefixMode" class="form-control" data-debug-id="FIELD_MERGE_PREFIX">
                        <option value="auto" selected>Auto (prefix only on conflict)</option>
                        <option value="always">Always (add prefix to all tools)</option>
                        <option value="none">None (no prefix, error on conflict)</option>
                    </select>
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        How to handle tool name conflicts: Auto adds prefix only when needed, Always adds prefix to all tools.
                    </p>
                </div>
                <div class="form-group">
                    <label>Protocol</label>
                    <select id="mergeProtocol" class="form-control" data-debug-id="FIELD_MERGE_PROTOCOL">
                        <option value="all" selected>All (SSE, Stdio, Streamable HTTP)</option>
                        <option value="sse">SSE only</option>
                        <option value="stdio">Stdio only</option>
                        <option value="streamable_http">Streamable HTTP only</option>
                    </select>
                </div>
                <div id="mergeServersResult" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-debug-id="BTN_MERGE_CANCEL" onclick="closeModal('mergeServersModal')">Cancel</button>
                <button class="btn btn-primary" data-debug-id="BTN_MERGE_CREATE" onclick="executeMergeServers()">
                    <span class="material-icons" style="font-size: 16px; margin-right: 4px;">merge_type</span>
                    Merge Servers
                </button>
            </div>
        </div>
    </div>

    <!-- Raw JSON View Modal -->
    <div id="rawJsonModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); backdrop-filter: blur(40px); background: rgba(255,255,255,0.95);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0,0,0,0.08); padding: 24px 28px 20px; background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(0,0,0,0.02) 100%);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(240,147,251,0.3);">
                        <span class="material-icons" style="color: white; font-size: 28px;">code</span>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #1d1d1f; letter-spacing: -0.3px;">Raw JSON</h2>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #86868b; font-weight: 400;">View tool definition</p>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="closeModal('rawJsonModal')" style="position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 8px; background: rgba(0,0,0,0.05); border: none; color: #86868b; font-size: 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">âœ•</button>
            </div>
            <div class="modal-body" style="padding: 24px 28px; overflow-y: auto; max-height: calc(80vh - 180px);">
                <pre id="rawJsonContent" style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 12px; overflow-x: auto; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 13px; line-height: 1.6; margin: 0;"></pre>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0,0,0,0.08); padding: 20px 28px; display: flex; gap: 12px; background: linear-gradient(180deg, rgba(0,0,0,0.01) 0%, rgba(0,0,0,0.03) 100%);">
                <button class="btn btn-secondary" onclick="copyJsonToClipboard()" style="flex: 1; padding: 14px 24px; background: linear-gradient(180deg, #0071e3 0%, #0077ed 100%); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,113,227,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,113,227,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,113,227,0.3)'">
                    <span class="material-icons" style="font-size: 20px;">content_copy</span> Copy to Clipboard
                </button>
                <button class="btn btn-secondary" onclick="closeModal('rawJsonModal')" style="padding: 14px 24px; background: rgba(0,0,0,0.05); color: #1d1d1f; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">Close</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><span class="material-icons" style="vertical-align: middle; margin-right: 8px;">help_outline</span>MCP Tool Editor Guide</h2>
                <button class="btn btn-icon" onclick="closeModal('helpModal')" style="position: absolute; top: 20px; right: 20px;">âœ•</button>
            </div>
            <div class="modal-body" style="padding: 20px 30px;">

                <!-- Tab Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #e5e5e5; padding-bottom: 0;">
                    <button class="help-tab-btn active" onclick="switchHelpTab('structure')" data-tab="structure" style="padding: 12px 24px; background: none; border: none; cursor: pointer; font-weight: 600; color: #86868b; border-bottom: 3px solid transparent; transition: all 0.2s;">
                        Tool Structure
                    </button>
                    <button class="help-tab-btn" onclick="switchHelpTab('property-flow')" data-tab="property-flow" style="padding: 12px 24px; background: none; border: none; cursor: pointer; font-weight: 600; color: #86868b; border-bottom: 3px solid transparent; transition: all 0.2s;">
                        Add Property Flow
                    </button>
                </div>

                <!-- Tool Structure Tab -->
                <div id="helpTabStructure" class="help-tab-content">
                    <h3 style="margin-top: 0;">Tool/Handler Arguments & Return Values</h3>

                    <svg viewBox="0 0 800 600" style="width: 100%; height: auto; border: 1px solid #e5e5e5; border-radius: 12px; background: #fafafa;">
                        <!-- Title -->
                        <text x="400" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#1d1d1f">MCP Tool/Handler Structure</text>

                        <!-- LLM Section -->
                        <rect x="50" y="60" width="200" height="80" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
                        <text x="150" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="#2e7d32">LLM (Claude)</text>
                        <text x="150" y="105" text-anchor="middle" font-size="12" fill="#555">Provides arguments</text>
                        <text x="150" y="125" text-anchor="middle" font-size="11" fill="#666">via inputSchema</text>

                        <!-- Arrow from LLM to Tool -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#0071e3" />
                            </marker>
                        </defs>
                        <line x1="250" y1="100" x2="340" y2="100" stroke="#0071e3" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="295" y="90" text-anchor="middle" font-size="11" fill="#0071e3" font-weight="600">Signature Args</text>

                        <!-- Tool Definition Box -->
                        <rect x="340" y="50" width="320" height="220" rx="10" fill="#fff" stroke="#0071e3" stroke-width="3"/>
                        <text x="500" y="75" text-anchor="middle" font-size="16" font-weight="bold" fill="#0071e3">Tool Definition</text>

                        <!-- inputSchema -->
                        <rect x="360" y="90" width="280" height="70" rx="6" fill="#e3f2fd" stroke="#1976d2" stroke-width="1.5"/>
                        <text x="500" y="110" text-anchor="middle" font-size="13" font-weight="bold" fill="#1976d2">inputSchema.properties</text>
                        <text x="370" y="130" font-size="10" fill="#555">â€¢ Signature parameters (LLM visible)</text>
                        <text x="370" y="145" font-size="10" fill="#555">â€¢ Required/Optional</text>

                        <!-- Internal Args -->
                        <rect x="360" y="170" width="280" height="85" rx="6" fill="#fff3e0" stroke="#ef6c00" stroke-width="1.5"/>
                        <text x="500" y="190" text-anchor="middle" font-size="13" font-weight="bold" fill="#ef6c00">Internal Args</text>
                        <text x="370" y="208" font-size="10" fill="#555">â€¢ Hidden from LLM</text>
                        <text x="370" y="223" font-size="10" fill="#555">â€¢ Fixed values (e.g., folder_id)</text>
                        <text x="370" y="238" font-size="10" fill="#555">â€¢ targetParam mapping</text>

                        <!-- Arrow to Handler -->
                        <line x1="660" y1="160" x2="730" y2="160" stroke="#0071e3" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="695" y="150" text-anchor="middle" font-size="11" fill="#0071e3" font-weight="600">All Args</text>

                        <!-- Handler Box -->
                        <rect x="50" y="310" width="700" height="120" rx="10" fill="#f5f5f7" stroke="#666" stroke-width="2"/>
                        <text x="400" y="335" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">Handler (Python Function)</text>

                        <!-- Handler Parameters -->
                        <rect x="70" y="350" width="320" height="60" rx="6" fill="#fff" stroke="#666" stroke-width="1"/>
                        <text x="230" y="370" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">Parameters Received</text>
                        <text x="80" y="390" font-size="10" fill="#555">â€¢ Signature params (from LLM)</text>
                        <text x="80" y="405" font-size="10" fill="#555">â€¢ Internal params (fixed values)</text>

                        <!-- Handler Return -->
                        <rect x="410" y="350" width="320" height="60" rx="6" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
                        <text x="570" y="370" text-anchor="middle" font-size="12" font-weight="bold" fill="#2e7d32">Return Value</text>
                        <text x="420" y="390" font-size="10" fill="#555">â€¢ dict, list, str, or custom object</text>
                        <text x="420" y="405" font-size="10" fill="#555">â€¢ Sent back to LLM</text>

                        <!-- Return arrow to LLM -->
                        <line x1="230" y1="430" x2="150" y2="500" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="190" y="470" text-anchor="middle" font-size="11" fill="#2e7d32" font-weight="600">Response</text>

                        <!-- LLM Response Box -->
                        <rect x="50" y="500" width="200" height="60" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
                        <text x="150" y="525" text-anchor="middle" font-size="14" font-weight="bold" fill="#2e7d32">LLM Receives</text>
                        <text x="150" y="545" text-anchor="middle" font-size="11" fill="#555">Handler return value</text>
                    </svg>

                    <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-left: 4px solid #0071e3; border-radius: 8px;">
                        <h4 style="margin-top: 0; color: #0071e3;">Key Concepts</h4>
                        <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Signature Parameters:</strong> Defined in inputSchema, visible to LLM</li>
                            <li><strong>Internal Parameters:</strong> Hidden from LLM, injected by system</li>
                            <li><strong>targetParam:</strong> Maps internal param name to handler's actual parameter name</li>
                            <li><strong>Handler:</strong> Python function decorated with @mcp_service</li>
                        </ul>
                    </div>
                </div>

                <!-- Add Property Flow Tab -->
                <div id="helpTabPropertyFlow" class="help-tab-content" style="display: none;">
                    <h3 style="margin-top: 0;">Add Property Data Flow</h3>

                    <svg viewBox="0 0 800 700" style="width: 100%; height: auto; border: 1px solid #e5e5e5; border-radius: 12px; background: #fafafa;">
                        <!-- Title -->
                        <text x="400" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#1d1d1f">Add Property Flow Diagram</text>

                        <!-- User Action -->
                        <rect x="300" y="60" width="200" height="60" rx="8" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
                        <text x="400" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="#1976d2">User Clicks</text>
                        <text x="400" y="105" text-anchor="middle" font-size="12" fill="#555">"Add Property"</text>

                        <!-- Arrow down -->
                        <line x1="400" y1="120" x2="400" y2="160" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- Property Type Selection -->
                        <rect x="250" y="160" width="300" height="80" rx="8" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
                        <text x="400" y="185" text-anchor="middle" font-size="14" font-weight="bold" fill="#ef6c00">Choose Property Type</text>
                        <text x="270" y="210" font-size="11" fill="#555">â–¡ Signature (LLM visible)</text>
                        <text x="270" y="228" font-size="11" fill="#555">â–¡ Internal (Hidden from LLM)</text>

                        <!-- Split into two paths -->
                        <line x1="400" y1="240" x2="250" y2="290" stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="400" y1="240" x2="550" y2="290" stroke="#ef6c00" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <text x="300" y="270" font-size="11" fill="#1976d2" font-weight="600">Signature</text>
                        <text x="500" y="270" font-size="11" fill="#ef6c00" font-weight="600">Internal</text>

                        <!-- Signature Path -->
                        <rect x="50" y="290" width="300" height="140" rx="8" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
                        <text x="200" y="315" text-anchor="middle" font-size="13" font-weight="bold" fill="#1976d2">Signature Property</text>

                        <text x="60" y="340" font-size="11" fill="#333" font-weight="600">Property Name:</text>
                        <rect x="60" y="345" width="270" height="20" rx="4" fill="#fff" stroke="#ccc" stroke-width="1"/>
                        <text x="70" y="360" font-size="10" fill="#999">e.g., "subject"</text>

                        <text x="60" y="380" font-size="11" fill="#333" font-weight="600">Where it goes:</text>
                        <text x="70" y="400" font-size="10" fill="#555">â†’ inputSchema.properties[name]</text>
                        <text x="70" y="415" font-size="10" fill="#555">â†’ Visible in LLM prompt</text>

                        <!-- Internal Path -->
                        <rect x="450" y="290" width="300" height="220" rx="8" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
                        <text x="600" y="315" text-anchor="middle" font-size="13" font-weight="bold" fill="#ef6c00">Internal Property</text>

                        <text x="460" y="340" font-size="11" fill="#333" font-weight="600">Property Name:</text>
                        <rect x="460" y="345" width="270" height="20" rx="4" fill="#fff" stroke="#ccc" stroke-width="1"/>
                        <text x="470" y="360" font-size="10" fill="#999">e.g., "folder_id"</text>

                        <text x="460" y="385" font-size="11" fill="#333" font-weight="600">Fixed Value:</text>
                        <rect x="460" y="390" width="270" height="20" rx="4" fill="#fff" stroke="#ccc" stroke-width="1"/>
                        <text x="470" y="405" font-size="10" fill="#999">e.g., "inbox_folder_id"</text>

                        <text x="460" y="425" font-size="11" fill="#333" font-weight="600">Target Param (optional):</text>
                        <rect x="460" y="430" width="270" height="20" rx="4" fill="#fff" stroke="#ccc" stroke-width="1"/>
                        <text x="470" y="445" font-size="10" fill="#999">e.g., "folderId" (handler param name)</text>

                        <text x="460" y="470" font-size="11" fill="#333" font-weight="600">Where it goes:</text>
                        <text x="470" y="490" font-size="10" fill="#555">â†’ tool_internal_args.json</text>
                        <text x="470" y="505" font-size="10" fill="#555">â†’ Hidden from LLM</text>

                        <!-- Final destination -->
                        <line x1="200" y1="430" x2="200" y2="550" stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <line x1="600" y1="510" x2="600" y2="550" stroke="#ef6c00" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <rect x="100" y="550" width="600" height="120" rx="8" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
                        <text x="400" y="575" text-anchor="middle" font-size="14" font-weight="bold" fill="#2e7d32">Handler Execution</text>

                        <text x="120" y="600" font-size="11" fill="#333" font-weight="600">Handler receives combined parameters:</text>
                        <text x="130" y="620" font-size="10" fill="#555">â€¢ Signature params (from LLM, e.g., subject="Meeting")</text>
                        <text x="130" y="640" font-size="10" fill="#555">â€¢ Internal params (fixed values, e.g., folderId="inbox_folder_id")</text>
                        <text x="130" y="660" font-size="10" fill="#555">â€¢ All merged before calling Python function</text>
                    </svg>

                    <div style="margin-top: 24px; padding: 16px; background: #fff3e0; border-left: 4px solid #ef6c00; border-radius: 8px;">
                        <h4 style="margin-top: 0; color: #ef6c00;">Property Classification Rules</h4>
                        <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Signature:</strong> LLM provides the value (e.g., search query, email subject)</li>
                            <li><strong>Internal:</strong> System provides fixed value (e.g., folder_id, credentials)</li>
                            <li><strong>targetParam:</strong> Use when handler parameter name differs from property name</li>
                            <li><strong>File Locations:</strong>
                                <ul style="margin-top: 4px;">
                                    <li>Signature â†’ <code>tool_definition_templates.py</code> (inputSchema)</li>
                                    <li>Internal â†’ <code>tool_internal_args.json</code></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
            <div class="modal-footer" style="padding: 20px 30px; border-top: 1px solid #e5e5e5; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('helpModal')" style="padding: 12px 24px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Generator Modal -->
    <div id="generatorModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); backdrop-filter: blur(40px); background: rgba(255,255,255,0.95);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0,0,0,0.08); padding: 24px 28px 20px; background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(0,0,0,0.02) 100%);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                        <span class="material-icons" style="color: white; font-size: 28px;">auto_fix_high</span>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #1d1d1f; letter-spacing: -0.3px;">Generate Server</h2>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #86868b; font-weight: 400;">Create MCP server from templates</p>
                    </div>
                </div>
                <button class="btn btn-icon" data-debug-id="BTN_GENERATOR_CLOSE" onclick="closeModal('generatorModal')" style="position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 8px; background: rgba(0,0,0,0.05); border: none; color: #86868b; font-size: 20px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">âœ•</button>
            </div>
            <div class="modal-body" style="padding: 24px 28px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px; letter-spacing: -0.1px;">Module</label>
                    <select id="generatorModule" class="form-control" data-debug-id="FIELD_GENERATOR_MODULE" onchange="handleGeneratorModuleChange()" style="width: 100%; padding: 12px 16px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 10px; font-size: 14px; color: #1d1d1f; background: white; transition: all 0.2s; outline: none;" onfocus="this.style.borderColor='#0071e3'; this.style.boxShadow='0 0 0 4px rgba(0,113,227,0.1)'" onblur="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.boxShadow='none'">
                        <option value="">Custom / Current Profile</option>
                    </select>
                    <p style="margin: 8px 0 0 0; color: #86868b; font-size: 12px; line-height: 1.4;">
                        Choose a module to auto-fill paths
                    </p>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px; letter-spacing: -0.1px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px; color: #0071e3;">description</span>
                        Tools Path
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input id="generatorToolsPath" class="form-control" data-debug-id="FIELD_GENERATOR_TOOLS_PATH" placeholder="/path/to/tool_definition_templates.py" style="flex: 1; padding: 12px 16px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 10px; font-size: 13px; color: #1d1d1f; background: white; transition: all 0.2s; font-family: 'SF Mono', Monaco, monospace;" onfocus="this.style.borderColor='#0071e3'; this.style.boxShadow='0 0 0 4px rgba(0,113,227,0.1)'" onblur="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.boxShadow='none'">
                        <button class="btn btn-secondary" data-debug-id="BTN_GENERATOR_TOOLS_PICK" onclick="selectFilePath('generatorToolsPath', '.py')" style="padding: 12px 16px; border-radius: 10px; background: rgba(0,0,0,0.05); border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">
                            <span class="material-icons" style="font-size: 20px; color: #1d1d1f;">folder_open</span>
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px; letter-spacing: -0.1px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px; color: #0071e3;">code</span>
                        Template Path
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input id="generatorTemplatePath" class="form-control" data-debug-id="FIELD_GENERATOR_TEMPLATE_PATH" value="/home/kimghw/Connector_auth/jinja/universal_server_template.jinja2" placeholder="/path/to/server_template.jinja2" style="flex: 1; padding: 12px 16px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 10px; font-size: 13px; color: #1d1d1f; background: white; transition: all 0.2s; font-family: 'SF Mono', Monaco, monospace;" onfocus="this.style.borderColor='#0071e3'; this.style.boxShadow='0 0 0 4px rgba(0,113,227,0.1)'" onblur="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.boxShadow='none'">
                        <button class="btn btn-secondary" data-debug-id="BTN_GENERATOR_TEMPLATE_PICK" onclick="selectFilePath('generatorTemplatePath', '.jinja2')" style="padding: 12px 16px; border-radius: 10px; background: rgba(0,0,0,0.05); border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">
                            <span class="material-icons" style="font-size: 20px; color: #1d1d1f;">folder_open</span>
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px; letter-spacing: -0.1px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px; color: #0071e3;">output</span>
                        Output Path
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input id="generatorOutputPath" class="form-control" data-debug-id="FIELD_GENERATOR_OUTPUT_PATH" placeholder="/path/to/server_generated.py" style="flex: 1; padding: 12px 16px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 10px; font-size: 13px; color: #1d1d1f; background: white; transition: all 0.2s; font-family: 'SF Mono', Monaco, monospace;" onfocus="this.style.borderColor='#0071e3'; this.style.boxShadow='0 0 0 4px rgba(0,113,227,0.1)'" onblur="this.style.borderColor='rgba(0,0,0,0.1)'; this.style.boxShadow='none'">
                        <button class="btn btn-secondary" data-debug-id="BTN_GENERATOR_OUTPUT_PICK" onclick="selectFilePath('generatorOutputPath', '.py')" style="padding: 12px 16px; border-radius: 10px; background: rgba(0,0,0,0.05); border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">
                            <span class="material-icons" style="font-size: 20px; color: #1d1d1f;">folder_open</span>
                        </button>
                    </div>
                </div>
                <div id="generatorResult" style="padding: 12px 16px; background: rgba(0,0,0,0.03); border-radius: 10px; color: #86868b; font-size: 13px; min-height: 20px; font-family: 'SF Mono', Monaco, monospace; line-height: 1.6;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0,0,0,0.08); padding: 20px 28px; display: flex; gap: 12px; background: linear-gradient(180deg, rgba(0,0,0,0.01) 0%, rgba(0,0,0,0.03) 100%);">
                <button class="btn btn-important" data-debug-id="BTN_GENERATOR_RUN" onclick="runServerGeneration()" style="flex: 1; padding: 14px 24px; background: linear-gradient(180deg, #0071e3 0%, #0077ed 100%); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,113,227,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,113,227,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,113,227,0.3)'">
                    <span class="material-icons" style="font-size: 20px;">auto_fix_high</span> Generate
                </button>
                <button class="btn btn-secondary" data-debug-id="BTN_GENERATOR_CLOSE_FOOTER" onclick="closeModal('generatorModal')" style="padding: 14px 24px; background: rgba(0,0,0,0.05); color: #1d1d1f; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">Cancel</button>
            </div>
        </div>
    </div>

    <!-- íŒŒìƒ ì„œë²„ ìƒì„± ëª¨ë‹¬ -->
    <div id="derive-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white; font-size: 24px;">call_split</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">íŒŒìƒ ì„œë²„ ìƒì„±</h3>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #86868b;">ê¸°ì¡´ í”„ë¡œí•„ì—ì„œ ìƒˆ í”„ë¡œí•„ ìƒì„±</p>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="closeDeriveModal()" style="position: absolute; top: 16px; right: 16px;">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 6px; display: block;">Base í”„ë¡œí•„</label>
                    <input type="text" id="derive-base" class="form-control" readonly style="background: #f5f5f7; color: #86868b;">
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 6px; display: block;">ìƒˆ í”„ë¡œí•„ëª… <span style="color: red;">*</span></label>
                    <input type="text" id="derive-name" class="form-control" placeholder="outlook_read">
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        ì˜ë¬¸, ìˆ«ìž, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš© ê°€ëŠ¥
                    </p>
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 6px; display: block;">í¬íŠ¸</label>
                    <input type="number" id="derive-port" class="form-control" value="8092" min="1024" max="65535">
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        ì„œë²„ í¬íŠ¸ ë²ˆí˜¸ (1024-65535)
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeriveModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmDerive()">
                    <span class="material-icons" style="font-size: 18px;">add_circle</span> ìƒì„±
                </button>
            </div>
        </div>
    </div>

    <!-- ë„êµ¬ ì´ë™ ëª¨ë‹¬ -->
    <div id="move-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white; font-size: 24px;">drive_file_move</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ë„êµ¬ ì´ë™/ë³µì‚¬</h3>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #86868b;">ì„ íƒí•œ ë„êµ¬ë¥¼ ë‹¤ë¥¸ í”„ë¡œí•„ë¡œ ì´ë™</p>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="closeMoveModal()" style="position: absolute; top: 16px; right: 16px;">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="selected-tools" style="background: #e3f2fd; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #1976d2;">
                        <span class="material-icons" style="font-size: 18px; vertical-align: middle;">checklist</span>
                        ì„ íƒëœ ë„êµ¬: <strong><span id="selected-count">0</span></strong>ê°œ
                    </p>
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 6px; display: block;">ëŒ€ìƒ í”„ë¡œí•„ <span style="color: red;">*</span></label>
                    <select id="move-target" class="form-control">
                        <option value="">-- ëŒ€ìƒ í”„ë¡œí•„ ì„ íƒ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 10px; display: block;">ëª¨ë“œ</label>
                    <div class="radio-group" style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border-color)'">
                            <input type="radio" name="move-mode" value="move" checked style="margin-right: 12px;" onchange="this.closest('label').style.borderColor='var(--primary-color)'; this.closest('.radio-group').querySelectorAll('label').forEach(l => { if(l !== this.closest('label')) l.style.borderColor='var(--border-color)'; })">
                            <div>
                                <span style="font-weight: 600; color: #1d1d1f;">ì´ë™</span>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">ì›ë³¸ í”„ë¡œí•„ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤</p>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border-color)'">
                            <input type="radio" name="move-mode" value="copy" style="margin-right: 12px;" onchange="this.closest('label').style.borderColor='var(--primary-color)'; this.closest('.radio-group').querySelectorAll('label').forEach(l => { if(l !== this.closest('label')) l.style.borderColor='var(--border-color)'; })">
                            <div>
                                <span style="font-weight: 600; color: #1d1d1f;">ë³µì‚¬</span>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">ì›ë³¸ í”„ë¡œí•„ì— ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMoveModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmMoveTools()">
                    <span class="material-icons" style="font-size: 18px;">check</span> í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- MCP ì„œë²„ ì‚­ì œ ëª¨ë‹¬ -->
    <div id="delete-server-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white; font-size: 24px;">delete_forever</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">MCP ì„œë²„ ì‚­ì œ</h3>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #86868b;">ì„œë¹„ìŠ¤ ì½”ë“œëŠ” ìœ ì§€ë©ë‹ˆë‹¤</p>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="closeDeleteServerModal()" style="position: absolute; top: 16px; right: 16px;">âœ•</button>
            </div>
            <div class="modal-body">
                <!-- ì‚­ì œ ëŒ€ìƒ ì •ë³´ -->
                <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span class="material-icons" style="color: #dc2626; font-size: 20px;">warning</span>
                        <span style="font-weight: 600; color: #dc2626;">ì‚­ì œ ëŒ€ìƒ í”„ë¡œí•„: <span id="delete-target-profile">-</span></span>
                    </div>
                    <p style="margin: 0; font-size: 12px; color: #991b1b;">ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- ì‚­ì œë  í•­ëª© -->
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 600; color: #dc2626; margin-bottom: 8px; display: block;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                        ì‚­ì œë  í•­ëª©:
                    </label>
                    <ul id="delete-items-list" style="margin: 0; padding-left: 20px; font-size: 12px; color: #666; line-height: 1.8;">
                        <li>mcp_editor/mcp_{profile}/ (ì›¹ì—ë””í„° ì •ì˜)</li>
                        <li>mcp_{profile}/mcp_server/ (ìƒì„±ëœ ì„œë²„)</li>
                        <li>registry_{profile}.json (ë ˆì§€ìŠ¤íŠ¸ë¦¬)</li>
                        <li>editor_config.jsonì—ì„œ í”„ë¡œí•„ í•­ëª©</li>
                    </ul>
                </div>

                <!-- ìœ ì§€ë  í•­ëª© -->
                <div style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 600; color: #16a34a; margin-bottom: 8px; display: block;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">check_circle</span>
                        ìœ ì§€ë  í•­ëª©:
                    </label>
                    <ul id="keep-items-list" style="margin: 0; padding-left: 20px; font-size: 12px; color: #666; line-height: 1.8;">
                        <li>{profile}_service.py (ì„œë¹„ìŠ¤ ë¡œì§)</li>
                        <li>{profile}_types.py (íƒ€ìž… ì •ì˜)</li>
                        <li>ê¸°íƒ€ ì„œë¹„ìŠ¤ íŒŒì¼ë“¤</li>
                    </ul>
                </div>

                <!-- í™•ì¸ ìž…ë ¥ -->
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 6px; display: block;">
                        ì‚­ì œ í™•ì¸ <span style="color: red;">*</span>
                    </label>
                    <p style="margin: 0 0 8px 0; font-size: 12px; color: #666;">
                        ì‚­ì œë¥¼ í™•ì¸í•˜ë ¤ë©´ ì•„ëž˜ì— <code id="delete-confirm-code" style="background: #fee2e2; padding: 2px 6px; border-radius: 4px; color: #dc2626; font-weight: 600;">DELETE {profile_name}</code>ì„ ì •í™•ížˆ ìž…ë ¥í•˜ì„¸ìš”.
                    </p>
                    <input type="text" id="delete-confirm-input" class="form-control" placeholder="DELETE profile_name" style="font-family: monospace;">
                    <p id="delete-confirm-error" style="margin-top: 6px; color: #dc2626; font-size: 12px; display: none;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteServerModal()">ì·¨ì†Œ</button>
                <button class="btn" id="delete-confirm-btn" onclick="confirmDeleteServer()" style="background: #dc2626; color: white;" disabled>
                    <span class="material-icons" style="font-size: 18px;">delete_forever</span> ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <!-- Server Dashboard Modal -->
    <div id="server-dashboard-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white; font-size: 24px;">dashboard</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">MCP ì„œë²„ ëŒ€ì‹œë³´ë“œ</h3>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #86868b;">í”„ë¡œí•„ë³„ ì„œë²„ ìƒíƒœ ë° ì„¤ì •</p>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="closeServerDashboard()" style="position: absolute; top: 16px; right: 16px;">âœ•</button>
            </div>
            <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 160px);">
                <!-- Dashboard Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 14px; font-weight: 600; color: #1d1d1f;">Server Profiles</span>
                        <button class="btn btn-sm" onclick="refreshDashboard()" style="padding: 6px 12px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <span class="material-icons" style="font-size: 16px;">refresh</span>
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #86868b;">
                        <span id="dashboard-last-update">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
                    </div>
                </div>

                <!-- Server Profiles Table -->
                <div style="background: white; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f7f7f7; border-bottom: 1px solid #e5e5e5;">
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #1d1d1f;">í”„ë¡œí•„</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #1d1d1f;">ì„œë²„</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #1d1d1f;">í¬íŠ¸</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #1d1d1f;">í”„ë¡œí† ì½œ (REST / STDIO / STREAM)</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #1d1d1f;">ê´€ê³„</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-profiles-body">
                            <tr>
                                <td colspan="5" style="padding: 40px; text-align: center; color: #86868b;">
                                    <span class="material-icons" style="font-size: 32px; display: block; margin-bottom: 8px;">hourglass_empty</span>
                                    ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Port Edit Section -->
                <div id="port-edit-section" style="margin-top: 20px; padding: 16px; background: #f7f7f7; border-radius: 12px; display: none;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #1d1d1f;">
                        <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">edit</span>
                        í¬íŠ¸ ë³€ê²½
                    </h4>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">í”„ë¡œí•„</label>
                            <select id="port-edit-profile" class="form-control" style="width: 100%; padding: 8px 12px;">
                                <option value="">-- í”„ë¡œí•„ ì„ íƒ --</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">ì„œë²„</label>
                            <input id="port-edit-server" type="text" class="form-control" style="width: 100%; padding: 8px 12px; background: #eee;" readonly>
                        </div>
                        <div style="width: 120px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">ìƒˆ í¬íŠ¸</label>
                            <input id="port-edit-value" type="number" class="form-control" min="1024" max="65535" placeholder="8080" style="width: 100%; padding: 8px 12px;">
                        </div>
                        <div style="padding-top: 20px;">
                            <button class="btn btn-primary" onclick="savePortChange()" style="padding: 8px 16px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">save</span>
                                ì €ìž¥
                            </button>
                        </div>
                    </div>
                    <p style="margin: 8px 0 0 0; font-size: 11px; color: #86868b;">
                        * í¬íŠ¸ ë³€ê²½ í›„ ì„œë²„ë¥¼ ìž¬ì‹œìž‘í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e5e5; padding: 16px 20px;">
                <button class="btn btn-secondary" onclick="closeServerDashboard()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- External JavaScript files (order matters for dependencies) -->
    <script src="/static/js/tool_editor_state.js"></script>
    <script src="/static/js/tool_editor_utils.js"></script>
    <script src="/static/js/tool_editor_server.js"></script>
    <script src="/static/js/tool_editor_tools.js"></script>
    <script src="/static/js/tool_editor_render.js"></script>
    <script src="/static/js/tool_editor_property.js"></script>
    <script src="/static/js/tool_editor_nested.js"></script>
    <script src="/static/js/tool_editor_debug.js"></script>
    <script src="/static/js/tool_editor_derive.js"></script>
    <script src="/static/js/tool_editor_dashboard.js"></script>
</body>
</html>
