<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Tool Definitions Editor</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0071e3;
            --primary-hover: #0077ed;
            --danger-color: #ff3b30;
            --danger-hover: #ff453a;
            --success-color: #34c759;
            --warning-color: #ff9f0a;
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --border-color: #d2d2d7;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --shadow-sm: 0 2px 5px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logos {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .brand-logo {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 980px; /* Pill shape */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: scale(1.02);
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-important {
            background: linear-gradient(135deg, #34c759 0%, #30b350 100%);
            color: white;
            font-weight: 600;
            padding: 10px 24px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-important:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(52, 199, 89, 0.4);
            filter: brightness(1.05);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tool-list {
            padding: 20px;
            flex: 1;
        }

        .tool-item {
            background: transparent;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .tool-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .tool-item.active {
            background: var(--primary-color);
            color: white;
        }

        .tool-item.active h3,
        .tool-item.active p {
            color: white;
        }

        .tool-item h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .tool-item p {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .editor-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-color: #fff;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            transition: all 0.2s;
            background: #fff;
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }

        .properties-container {
            background: #fbfbfd;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        .property-item {
            background: white;
            padding: 20px;
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f5f5f7;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 6px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: scaleIn 0.2s;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.9);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .modal-header h2, .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .close-btn:hover {
            color: #000;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #fbfbfd;
        }

        .backup-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .backup-item {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .backup-info {
            flex: 1;
        }

        .backup-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .backup-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: var(--shadow-md);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .json-editor {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: var(--radius-md);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            border: 1px solid #333;
        }

        .add-button {
            width: 100%;
            padding: 12px;
            border: 1px dashed var(--primary-color);
            background: rgba(0, 113, 227, 0.05);
            color: var(--primary-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-button:hover {
            background: rgba(0, 113, 227, 0.1);
        }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .collapsible-header:hover {
            background: #e8e8e8;
        }

        .collapse-icon {
            margin-right: 8px;
            transition: transform 0.2s;
            font-family: monospace;
            font-size: 16px;
            color: #666;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        .property-collapsible {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .property-collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .property-collapse-header:hover {
            background: #f7f7ff;
        }

        .property-collapse-header.expanded {
            background: #f7f7ff;
            border-bottom: 1px solid #e5e5e5;
        }

        .property-collapse-content {
            padding: 16px;
            background: #fafafa;
        }

        .property-collapse-content.collapsed {
            display: none;
        }

        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #86868b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="brand-logos" aria-label="MCP, Claude, OpenAI, Gemini">
                    <img class="brand-logo" src="/static/brands/mcp.svg" alt="MCP" title="MCP" />
                    <img class="brand-logo" src="/static/brands/claude.svg" alt="Claude" title="Claude" />
                    <img class="brand-logo" src="/static/brands/openai.svg" alt="OpenAI" title="OpenAI" />
                    <img class="brand-logo" src="/static/brands/gemini.svg" alt="Gemini" title="Gemini" />
                </span>
                <span>MCP Tool Definitions Editor</span>
            </h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="loadTools()">
                    <span class="material-icons">refresh</span> Reload
                </button>
                <button class="btn btn-secondary" onclick="showBackups()">
                    <span class="material-icons">inventory_2</span> Backups
                </button>
                <button class="btn btn-secondary" onclick="validateTools()">
                    <span class="material-icons">check_circle</span> Validate
                </button>
                <button class="btn btn-primary" onclick="saveTools()">
                    <span class="material-icons">save</span> Save Changes
                </button>
                <button class="btn btn-important" onclick="openGeneratorModal()">
                    <span class="material-icons">auto_fix_high</span> Generate Server
                </button>
            </div>
        </div>
        <div id="profileTabs" style="display: flex; justify-content: flex-start; gap: 8px; padding: 10px 20px; background: #f7f7f7; border-bottom: 1px solid #e5e5e5;">
            <!-- Profile tabs will be rendered here -->
        </div>
        <div id="templateSelector" style="display: flex; gap: 12px; align-items: center; padding: 8px 20px; background: #fff9e6; border-bottom: 1px solid #e5e5e5;">
            <label style="font-size: 13px; font-weight: 500; color: #666; white-space: nowrap;">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">description</span>
                Load Template:
            </label>
            <select id="templateSource" class="form-control" style="flex: 1; max-width: 400px; padding: 6px 12px; font-size: 13px;">
                <option value="">-- Current Template --</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="loadFromSelectedTemplate()" title="Load tools from selected template">
                <span class="material-icons" style="font-size: 14px;">file_download</span> Load
            </button>
            <span id="templateLoadStatus" style="font-size: 12px; color: #666;"></span>
            <span style="font-size: 11px; color: #999; margin-left: auto;">
                * Save will update: <strong id="saveTargetLabel">current profile</strong>
            </span>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="tool-list">
                    <button class="add-button" onclick="addNewTool()">
                        <span class="material-icons">add</span> Add New Tool
                    </button>
                    <div id="toolList" style="margin-top: 15px;">
                        <!-- Tool items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="editor-area">
                <div id="editorContent">
                    <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                        Select a tool from the left sidebar to edit
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nested Properties Modal -->
    <div id="nestedPropertiesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="nestedModalTitle">Edit Nested Properties</h2>
                <button class="btn btn-icon" onclick="closeModal('nestedPropertiesModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="nestedPropertiesEditor">
                    <!-- Nested properties editor will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveNestedProperties()">Save Properties</button>
                <button class="btn btn-secondary" onclick="closeModal('nestedPropertiesModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- BaseModel Selector Modal -->
    <div id="baseModelModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Select BaseModel to Import</h2>
                <button class="btn btn-icon" onclick="closeModal('baseModelModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="baseModelList" style="max-height: 500px; overflow-y: auto;">
                    <!-- BaseModel list will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('baseModelModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Nested Graph Types Modal -->
    <div id="nestedGraphTypesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Nested Properties</h2>
                <button class="btn btn-icon" onclick="closeModal('nestedGraphTypesModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Type (from outlook_types.py)</label>
                    <select id="nestedGraphTypeClass" onchange="handleNestedGraphClassChange()" class="form-control">
                        <option value="">-- Select Type --</option>
                        <option value="FilterParams">FilterParams (Filter criteria)</option>
                        <option value="ExcludeParams">ExcludeParams (Exclusion criteria)</option>
                        <option value="SelectParams">SelectParams (Field selection)</option>
                    </select>
                </div>
                <div class="form-group" id="nestedPropertySelectionDiv" style="display: none;">
                    <label>Select Properties to Add</label>
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;">
                        <div id="nestedPropertyCheckboxList">
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllNestedProperties(true)">Select All</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllNestedProperties(false)">Deselect All</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllNestedRequired(true)">All Required</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllNestedRequired(false)">All Optional</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmAddNestedGraphProperties()">Add Selected</button>
                <button class="btn btn-secondary" onclick="closeModal('nestedGraphTypesModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Backup Management</h2>
                <button class="btn btn-icon" onclick="closeModal('backupModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="backupList" class="backup-list">
                    <!-- Backup items will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('backupModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Generator Modal -->
    <div id="generatorModal" class="modal">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header">
                <h2>Generate MCP Server</h2>
                <button class="btn btn-icon" onclick="closeModal('generatorModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Module</label>
                    <select id="generatorModule" class="form-control" onchange="handleGeneratorModuleChange()">
                        <option value="">Custom / Current Profile</option>
                    </select>
                    <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Detected modules share the same mcp folder layout. Choose one to auto-fill generator args.
                    </p>
                </div>
                <div class="form-group">
                    <label>Tools path (--tools)</label>
                    <input id="generatorToolsPath" class="form-control" placeholder="/path/to/tool_definition_templates.py">
                </div>
                <div class="form-group">
                    <label>Template path (--template)</label>
                    <input id="generatorTemplatePath" class="form-control" placeholder="/path/to/server_template.jinja2">
                </div>
                <div class="form-group">
                    <label>Output path (--output)</label>
                    <input id="generatorOutputPath" class="form-control" placeholder="/path/to/server_generated.py">
                </div>
                <div id="generatorResult" style="color: var(--text-secondary); font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-important" onclick="runServerGeneration()">
                    <span class="material-icons">auto_fix_high</span> Generate
                </button>
                <button class="btn btn-secondary" onclick="closeModal('generatorModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        let tools = [];
        let currentToolIndex = -1;
        let nestedGraphTarget = null;
        let currentProfile = '';
        let profiles = [];
        let generatorModules = [];
        let generatorFallback = {};
        let templateSources = [];  // Available template files (current, backups, other profiles)
        let originalProfile = '';  // The profile that tools were originally loaded from (for saving)

        // Load tools on page load
        window.onload = function() {
            console.log('[DEBUG] window.onload triggered');
            console.log('[DEBUG] Calling loadProfiles()...');
            loadProfiles();
            console.log('[DEBUG] Calling loadGraphTypesProperties()...');
            loadGraphTypesProperties();
            console.log('[DEBUG] window.onload completed');
        };

        function loadTemplateSources() {
            // Load available template files (current, backups, other profiles)
            const profileQuery = profileParam();
            fetch(`/api/template-sources${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    templateSources = data.sources || [];
                    renderTemplateSourceSelector();
                })
                .catch(error => {
                    console.error('Error loading template sources:', error);
                    templateSources = [];
                    renderTemplateSourceSelector();
                });
        }

        function renderTemplateSourceSelector() {
            const select = document.getElementById('templateSource');
            if (!select) return;

            select.innerHTML = '<option value="">-- Current Template --</option>';
            templateSources.forEach(source => {
                if (source.type === 'current') return; // Skip current, it's the default

                const opt = document.createElement('option');
                opt.value = source.path;
                // Format: "backup_20241217.py (5 tools)" or "outlook template (3 tools)"
                const dateStr = source.modified ? new Date(source.modified).toLocaleString() : '';
                let label = source.name;
                if (source.type === 'backup') {
                    label = `ðŸ“¦ ${source.name}`;
                } else if (source.type === 'other_profile') {
                    label = `ðŸ“ ${source.name}`;
                }
                opt.textContent = `${label} (${source.count} tools)`;
                opt.title = dateStr ? `Modified: ${dateStr}` : '';
                select.appendChild(opt);
            });

            // Update save target label
            const saveLabel = document.getElementById('saveTargetLabel');
            if (saveLabel) {
                saveLabel.textContent = originalProfile || 'default';
            }
        }

        function loadFromSelectedTemplate() {
            const select = document.getElementById('templateSource');
            const statusEl = document.getElementById('templateLoadStatus');
            const sourcePath = select ? select.value : '';

            if (!sourcePath) {
                // Load from current template (default behavior)
                loadTools();
                return;
            }

            if (statusEl) {
                statusEl.textContent = 'Loading...';
                statusEl.style.color = '#666';
            }

            fetch('/api/template-sources/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: sourcePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    tools = data.tools;
                    currentToolIndex = -1;
                    renderToolList();

                    if (statusEl) {
                        statusEl.textContent = `âœ“ Loaded ${data.count} tools`;
                        statusEl.style.color = '#34c759';
                        setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
                    }

                    showNotification(`Loaded ${data.count} tools from template. Save will update "${originalProfile || 'default'}"`, 'success');

                    // Clear editor
                    const editorContent = document.getElementById('editorContent');
                    if (editorContent) {
                        editorContent.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                                <p>Loaded ${data.count} tools from: ${sourcePath.split('/').pop()}</p>
                                <p style="font-size: 12px; margin-top: 10px;">Select a tool from the left sidebar to edit</p>
                            </div>
                        `;
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = 'âœ— Failed';
                        statusEl.style.color = '#ff3b30';
                    }
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading template:', error);
                if (statusEl) {
                    statusEl.textContent = 'âœ— Failed';
                    statusEl.style.color = '#ff3b30';
                }
                showNotification('Failed to load template', 'error');
            });
        }

        function loadMcpServices() {
            // Load MCP services for current profile
            const profileQuery = originalProfile ? `?profile=${encodeURIComponent(originalProfile)}` : '';

            fetch(`/api/mcp-services${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    window.mcpServiceDetails = data.services_with_signatures || [];
                    // Use service names from services_with_signatures (these match mcp_service.name)
                    // Fall back to data.services if services_with_signatures is empty
                    if (window.mcpServiceDetails.length > 0) {
                        window.mcpServices = window.mcpServiceDetails.map(svc => svc.name).filter(Boolean);
                    } else {
                        window.mcpServices = data.services || [];
                    }
                    console.log('MCP Services loaded:', window.mcpServices, 'from profile:', originalProfile || 'default');
                    console.log('MCP Service details loaded:', window.mcpServiceDetails);

                    if (currentToolIndex >= 0) {
                        renderToolEditor(tools[currentToolIndex], currentToolIndex);
                    }
                })
                .catch(error => {
                    console.error('Error loading MCP services:', error);
                    window.mcpServices = [];
                    window.mcpServiceDetails = [];
                });
        }

        function loadTools() {
            console.log('[DEBUG] loadTools() called');
            const profileQuery = profileParam();
            fetch(`/api/tools${profileQuery}`)
                .then(response => {
                    console.log('[DEBUG] Response received:', response.status, response.ok);
                    return response.json();
                })
                .then(data => {
                    console.log('[DEBUG] Data received:', data);
                    const loadedTools = data.tools || data;
                    tools = loadedTools;
                    console.log('[DEBUG] tools variable set, tools.length:', tools.length);
                    console.log('[DEBUG] Calling renderToolList()...');
                    renderToolList();
                    console.log('[DEBUG] renderToolList() completed');
                    showNotification(`Tools loaded (${currentProfile || 'default'})`, 'success');
                })
                .catch(error => {
                    console.error('[ERROR] Error loading tools:', error);
                    showNotification('Failed to load tools', 'error');
                });
        }

        // Load graph types properties for current profile
        function loadGraphTypesProperties() {
            const profileQuery = originalProfile ? `?profile=${encodeURIComponent(originalProfile)}` : '';
            fetch(`/api/graph-types-properties${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    window.graphTypesProperties = data;
                    window.hasTypesFile = data.has_types || false;
                    window.typesName = data.types_name || 'types';
                    console.log('Loaded graph types properties:', data, 'hasTypes:', window.hasTypesFile, 'typesName:', window.typesName);
                })
                .catch(error => {
                    console.error('Error loading graph types properties:', error);
                    window.graphTypesProperties = null;
                    window.hasTypesFile = false;
                    window.typesName = 'types';
                });
        }

        function loadProfiles() {
            fetch('/api/profiles')
                .then(response => response.json())
                .then(data => {
                    profiles = data.profiles || [];
                    currentProfile = data.active || (profiles[0] || '');
                    originalProfile = currentProfile;  // Store original profile for saving
                    renderProfileTabs();
                    loadTools();
                    loadGeneratorDefaults();
                    loadTemplateSources();  // Load available template sources
                    loadMcpServices();  // Load MCP services for current profile
                })
                .catch(error => {
                    console.error('Error loading profiles:', error);
                    profiles = [];
                    currentProfile = '';
                    originalProfile = '';
                    renderProfileTabs();
                    loadTools();
                    loadGeneratorDefaults();
                    loadTemplateSources();
                    loadMcpServices();
                });
        }

        function loadGeneratorDefaults() {
            const profileQuery = profileParam();
            fetch(`/api/server-generator/defaults${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    generatorModules = data.modules || [];
                    generatorFallback = data.fallback || {};
                    renderGeneratorOptions();
                })
                .catch(error => {
                    console.error('Error loading generator defaults:', error);
                    generatorModules = [];
                    generatorFallback = {};
                });
        }

        function renderGeneratorOptions() {
            const select = document.getElementById('generatorModule');
            if (!select) return;

            select.innerHTML = '<option value="">Custom / Current Profile</option>';
            generatorModules.forEach(mod => {
                const opt = document.createElement('option');
                opt.value = mod.name;
                opt.textContent = mod.name;
                select.appendChild(opt);
            });

            const defaultValue = generatorModules.length > 0 ? generatorModules[0].name : '';
            select.value = defaultValue;
            applyGeneratorDefaults(defaultValue);
        }

        function applyGeneratorDefaults(moduleName) {
            const defaults = generatorModules.find(m => m.name === moduleName) || generatorFallback || {};
            const toolsInput = document.getElementById('generatorToolsPath');
            const templateInput = document.getElementById('generatorTemplatePath');
            const outputInput = document.getElementById('generatorOutputPath');

            if (toolsInput) toolsInput.value = defaults.tools_path || '';
            if (templateInput) templateInput.value = defaults.template_path || '';
            if (outputInput) outputInput.value = defaults.output_path || '';
        }

        function handleGeneratorModuleChange() {
            const select = document.getElementById('generatorModule');
            const moduleName = select ? select.value : '';
            applyGeneratorDefaults(moduleName);
        }

        function openGeneratorModal() {
            if (!generatorModules.length && !generatorFallback.tools_path) {
                loadGeneratorDefaults();
            }
            applyGeneratorDefaults(document.getElementById('generatorModule')?.value || '');
            const resultEl = document.getElementById('generatorResult');
            if (resultEl) resultEl.textContent = '';
            document.getElementById('generatorModal').classList.add('show');
        }

        function runServerGeneration() {
            const profileQuery = profileParam();
            const payload = {
                module: document.getElementById('generatorModule')?.value || null,
                tools_path: document.getElementById('generatorToolsPath')?.value || '',
                template_path: document.getElementById('generatorTemplatePath')?.value || '',
                output_path: document.getElementById('generatorOutputPath')?.value || ''
            };

            fetch(`/api/server-generator${profileQuery}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json().then(data => ({status: response.status, data})))
            .then(({status, data}) => {
                const resultEl = document.getElementById('generatorResult');
                if (status >= 200 && status < 300 && data.success) {
                    showNotification(`Generated server at ${data.output_path}`, 'success');
                    if (resultEl) resultEl.textContent = `Output: ${data.output_path} (${data.tool_count} tools)`;
                } else {
                    const message = data.error || 'Failed to generate server';
                    showNotification(message, 'error');
                    if (resultEl) resultEl.textContent = message;
                }
            })
            .catch(error => {
                console.error('Error generating server:', error);
                showNotification('Failed to generate server', 'error');
            });
        }

        function renderProfileTabs() {
            const tabContainer = document.getElementById('profileTabs');
            if (!tabContainer) return;
            tabContainer.innerHTML = '';
            if (!profiles || profiles.length === 0) {
                tabContainer.textContent = 'No profiles found (using default)';
            } else {
                profiles.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary';
                    btn.style = 'border-radius: 8px; padding: 10px 20px; font-size: 15px; min-width: 120px; text-align: center; font-weight: bold;';
                    if (name === currentProfile) {
                        btn.style.background = 'var(--primary-color)';
                        btn.style.color = '#fff';
                    }
                    btn.textContent = name;
                    btn.onclick = () => {
                        currentProfile = name;
                        originalProfile = name;  // Update original profile when switching
                        renderProfileTabs();
                        loadTools();
                        loadGeneratorDefaults();
                        loadTemplateSources();  // Reload template sources for new profile
                        loadMcpServices();  // Reload MCP services for new profile
                        loadGraphTypesProperties();  // Reload types for new profile
                        // Reset template selector to default
                        const templateSelect = document.getElementById('templateSource');
                        if (templateSelect) templateSelect.value = '';
                    };
                    tabContainer.appendChild(btn);
                });
            }
            // Add "+" button for new project
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-secondary';
            addBtn.style = 'border-radius: 8px; padding: 10px 16px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center;';
            addBtn.textContent = '+';
            addBtn.title = 'Add new project';
            addBtn.onclick = () => showNewProjectModal();
            tabContainer.appendChild(addBtn);
        }

        function showNewProjectModal() {
            // Remove existing modal if any
            const existing = document.getElementById('newProjectModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'newProjectModal';
            modal.style = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 24px; border-radius: 12px; width: 500px; max-width: 90%;">
                    <h3 style="margin-top: 0; margin-bottom: 16px;">New Project</h3>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>Project Name *</label>
                        <input type="text" id="newProjectName" class="form-control" placeholder="e.g., calendar, teams, sharepoint">
                        <small style="color: var(--text-secondary);">Will be used as profile name (lowercase, underscores)</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>MCP Server Path</label>
                        <input type="text" id="newProjectMcpPath" class="form-control" placeholder="../mcp_{name}/mcp_server">
                        <small style="color: var(--text-secondary);">Path to MCP server directory (relative to mcp_editor)</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>Port</label>
                        <input type="number" id="newProjectPort" class="form-control" value="8091">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="newProjectCreateMcp" checked>
                            Create MCP server directory structure
                        </label>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createNewProject()">Create Project</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeNewProjectModal(); };
            document.getElementById('newProjectName').focus();
        }

        function closeNewProjectModal() {
            const modal = document.getElementById('newProjectModal');
            if (modal) modal.remove();
        }

        async function createNewProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (!name) {
                showNotification('Project name is required', 'error');
                return;
            }

            const mcpPath = document.getElementById('newProjectMcpPath').value.trim() || `../mcp_${name.toLowerCase().replace(/\s+/g, '_')}/mcp_server`;
            const port = parseInt(document.getElementById('newProjectPort').value) || 8091;
            const createMcp = document.getElementById('newProjectCreateMcp').checked;

            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        mcp_server_path: mcpPath,
                        port: port,
                        create_mcp_structure: createMcp
                    })
                });

                const result = await response.json();
                if (result.error) {
                    showNotification(result.error, 'error');
                    return;
                }

                showNotification(`Project "${result.profile}" created successfully!`, 'success');
                closeNewProjectModal();

                // Reload profiles and switch to new one
                profiles.push(result.profile);
                currentProfile = result.profile;
                renderProfileTabs();
                loadTools();
                loadGeneratorDefaults();
            } catch (error) {
                showNotification('Failed to create project: ' + error.message, 'error');
            }
        }

        function profileParam() {
            // Always use originalProfile for saving operations
            // This ensures changes are saved to the profile where tools were loaded from,
            // even if MCP services are loaded from a different template source
            return originalProfile ? `?profile=${encodeURIComponent(originalProfile)}` : '';
        }

        function populateGraphTypeOptions(selectEl) {
            if (!selectEl || !window.graphTypesProperties || !Array.isArray(window.graphTypesProperties.classes)) {
                return;
            }
            const existing = Array.from(selectEl.options).map(opt => opt.value);
            window.graphTypesProperties.classes.forEach(cls => {
                const name = cls.name || '';
                if (!name || existing.includes(name)) {
                    return;
                }
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });
        }

        function renderToolList() {
            console.log('[DEBUG] renderToolList() called');
            console.log('[DEBUG] tools.length:', tools.length);
            console.log('[DEBUG] currentToolIndex:', currentToolIndex);

            const toolList = document.getElementById('toolList');
            if (!toolList) {
                console.error('[ERROR] toolList element not found!');
                return;
            }
            console.log('[DEBUG] toolList element found');

            console.log('[DEBUG] Clearing toolList.innerHTML');
            toolList.innerHTML = '';

            console.log('[DEBUG] Starting forEach loop...');
            tools.forEach((tool, index) => {
                console.log(`[DEBUG] Processing tool ${index}: ${tool.name}`);
                const toolItem = document.createElement('div');
                toolItem.className = 'tool-item';
                if (index === currentToolIndex) {
                    toolItem.classList.add('active');
                }
                toolItem.onclick = () => selectTool(index);
                toolItem.innerHTML = `
                    <h3>${tool.name}</h3>
                    <p>${tool.description}</p>
                `;
                toolList.appendChild(toolItem);
                console.log(`[DEBUG] Tool ${index} appended to DOM`);
            });
            console.log('[DEBUG] forEach loop completed, total tools:', tools.length);
        }

        function selectTool(index) {
            currentToolIndex = index;
            renderToolList();
            renderToolEditor(tools[index], index);
        }

        function renderToolEditor(tool, index) {
            const editorContent = document.getElementById('editorContent');

            const properties = tool.inputSchema?.properties || {};
            const required = tool.inputSchema?.required || [];

            let propertiesHtml = '';
            for (const [propName, propDef] of Object.entries(properties)) {
                const isRequired = required.includes(propName);
                const propId = `prop-${index}-${propName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                propertiesHtml += `
                    <div class="property-collapsible">
                        <div class="property-collapse-header" onclick="togglePropertyCollapse('${propId}')" id="header-${propId}">
                            <div style="display: flex; align-items: center;">
                                <span class="collapse-icon" id="icon-${propId}">â–¼</span>
                                <strong style="font-size: 15px; color: #333;">${propName}</strong>
                                <span style="margin-left: 12px; font-size: 12px; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 4px;">${propDef.type}</span>
                                ${isRequired ? '<span style="margin-left: 8px; font-size: 11px; color: var(--danger-color); font-weight: 600;">REQUIRED</span>' : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;" onclick="event.stopPropagation();">
                                ${propDef.type === 'object' ? `
                                <button class="btn btn-sm"
                                        style="background: ${propDef.baseModel ? 'var(--success-color)' : 'var(--primary-color)'}; color: white; padding: 4px 12px; border-radius: 980px; font-size: 11px;"
                                        onclick="showBaseModelSelector(${index}, '${propName}')">
                                    ${propDef.baseModel || 'Select BaseModel'}
                                </button>
                                ` : ''}
                                <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                    <input type="checkbox" ${isRequired ? 'checked' : ''}
                                           onchange="toggleRequired(${index}, '${propName}', this.checked)"
                                           style="margin-right: 6px;">
                                    <span style="color: ${isRequired ? 'var(--danger-color)' : 'var(--text-secondary)'}; font-size: 13px; font-weight: 500;">Required</span>
                                </label>
                                <button class="btn btn-icon btn-sm" onclick="removeProperty(${index}, '${propName}')"><span class="material-icons">close</span></button>
                            </div>
                        </div>
                        <div class="property-collapse-content" id="content-${propId}">
                        <div class="form-group">
                            <label>Type</label>
                            <select class="form-control"
                                    onchange="updatePropertyField(${index}, '${propName}', 'type', this.value); renderToolEditor(tools[${index}], ${index});">
                                <option value="string" ${propDef.type === 'string' ? 'selected' : ''}>string</option>
                                <option value="number" ${propDef.type === 'number' ? 'selected' : ''}>number</option>
                                <option value="integer" ${propDef.type === 'integer' ? 'selected' : ''}>integer</option>
                                <option value="boolean" ${propDef.type === 'boolean' ? 'selected' : ''}>boolean</option>
                                <option value="array" ${propDef.type === 'array' ? 'selected' : ''}>array</option>
                                <option value="object" ${propDef.type === 'object' ? 'selected' : ''}>object</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control"
                                      onchange="updatePropertyField(${index}, '${propName}', 'description', this.value)">${propDef.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Default</label>
                            <input class="form-control"
                                   value="${propDef.default !== undefined ? propDef.default : ''}"
                                   placeholder="Optional default value"
                                   onchange="updatePropertyField(${index}, '${propName}', 'default', parseDefaultValue(this.value, '${propDef.type}'))">
                        </div>
                        ${propDef.enum ? `
                        <div class="form-group">
                            <label>Enum Values (comma-separated)</label>
                            <input class="form-control" value="${propDef.enum.join(', ')}"
                                   onchange="updatePropertyEnum(${index}, '${propName}', this.value)">
                        </div>
                        ` : ''}
                        ${propDef.type === 'array' ? `
                        <div class="form-group">
                            <label>Array Item Type</label>
                            <select class="form-control"
                                    onchange="updatePropertyField(${index}, '${propName}', 'items', {type: this.value})">
                                <option value="string" ${propDef.items?.type === 'string' ? 'selected' : ''}>string</option>
                                <option value="number" ${propDef.items?.type === 'number' ? 'selected' : ''}>number</option>
                                <option value="integer" ${propDef.items?.type === 'integer' ? 'selected' : ''}>integer</option>
                                <option value="boolean" ${propDef.items?.type === 'boolean' ? 'selected' : ''}>boolean</option>
                                <option value="object" ${propDef.items?.type === 'object' ? 'selected' : ''}>object</option>
                            </select>
                        </div>
                        ` : ''}
                        ${propDef.type === 'object' && propDef.properties ? `
                        <div class="form-group">
                            <label>Nested Properties</label>
                            <div style=" padding: 20px; background: var(--bg-color); border-left: 3px solid ${propDef.baseModel ? 'var(--success-color)' : 'var(--primary-color)'}; border-radius: var(--radius-sm);">
                                ${Object.entries(propDef.properties).map(([nestedPropName, nestedProp]) => {
                                    const nestedIsRequired = propDef.required && propDef.required.includes(nestedPropName);
                                    return `
                                    <div style="padding: 16px; margin-bottom: 12px; background: white; border: 1px solid var(--border-color); border-radius: var(--radius-sm); box-shadow: var(--shadow-sm);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <strong style="color: var(--text-primary); font-size: 14px;">${nestedPropName}</strong>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <select style="font-size: 12px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 6px; background: white;"
                                                        onchange="updateNestedPropertyType(${index}, '${propName}', '${nestedPropName}', this.value); renderToolEditor(tools[${index}], ${index});">
                                                    <option value="string" ${nestedProp.type === 'string' ? 'selected' : ''}>string</option>
                                                    <option value="number" ${nestedProp.type === 'number' ? 'selected' : ''}>number</option>
                                                    <option value="integer" ${nestedProp.type === 'integer' ? 'selected' : ''}>integer</option>
                                                    <option value="boolean" ${nestedProp.type === 'boolean' ? 'selected' : ''}>boolean</option>
                                                    <option value="array" ${nestedProp.type === 'array' ? 'selected' : ''}>array</option>
                                                    <option value="object" ${nestedProp.type === 'object' ? 'selected' : ''}>object</option>
                                                </select>
                                                <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                                                    <input type="checkbox" ${nestedIsRequired ? 'checked' : ''}
                                                           onchange="toggleNestedRequired(${index}, '${propName}', '${nestedPropName}', this.checked)"
                                                           style="margin-right: 4px;">
                                                    <span style="color: ${nestedIsRequired ? 'var(--danger-color)' : 'var(--text-secondary)'}; font-size: 12px;">Required</span>
                                                </label>
                                                <button class="btn btn-icon btn-sm" style="padding: 4px 8px;"
                                                        onclick="removeNestedPropertyInline(${index}, '${propName}', '${nestedPropName}')"><span class="material-icons">close</span></button>
                                            </div>
                                        </div>
                                        <textarea class="form-control" style="font-size: 13px; min-height: 60px;"
                                                  placeholder="Description"
                                                  onchange="updateNestedPropertyDescription(${index}, '${propName}', '${nestedPropName}', this.value)">${nestedProp.description || ''}</textarea>
                                        <div class="form-group" style="margin-top: 10px;">
                                            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px; text-transform: uppercase;">Default</label>
                                            <input class="form-control" style="font-size: 13px; padding: 8px;"
                                                   placeholder="Optional default value"
                                                   value="${nestedProp.default !== undefined ? nestedProp.default : ''}"
                                                   onchange="updateNestedPropertyDefault(${index}, '${propName}', '${nestedPropName}', parseDefaultValue(this.value, '${nestedProp.type}'))">
                                        </div>

                                        ${(nestedProp.type === 'string' || nestedProp.type === 'number' || nestedProp.type === 'integer') ? `
                                        <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div>
                                                <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px; text-transform: uppercase;">Format</label>
                                                <input class="form-control" style="font-size: 13px; padding: 8px;"
                                                       placeholder="e.g., date, email, uri"
                                                       value="${nestedProp.format || ''}"
                                                       onchange="updateNestedPropertyFormat(${index}, '${propName}', '${nestedPropName}', this.value)">
                                            </div>
                                            ${nestedProp.type === 'string' ? `
                                            <div>
                                                <label style="font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; margin-bottom: 4px; text-transform: uppercase;">
                                                    <input type="checkbox" ${nestedProp.enum ? 'checked' : ''}
                                                           onchange="toggleNestedEnum(${index}, '${propName}', '${nestedPropName}', this.checked)"
                                                           style="margin-right: 4px;">
                                                    Has Enum
                                                </label>
                                                ${nestedProp.enum ? `
                                                <input class="form-control" style="font-size: 13px; padding: 8px;"
                                                       placeholder="Comma-separated values"
                                                       value="${nestedProp.enum.join(', ')}"
                                                       onchange="updateNestedPropertyEnum(${index}, '${propName}', '${nestedPropName}', this.value)">
                                                ` : ''}
                                            </div>
                                            ` : '<div></div>'}
                                        </div>
                                        ` : ''}

                                        ${nestedProp.type === 'array' ? `
                                        <div style="margin-top: 12px;">
                                            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px; text-transform: uppercase;">Array Item Type</label>
                                            <select class="form-control" style="font-size: 13px; padding: 8px;"
                                                    onchange="updateNestedPropertyItems(${index}, '${propName}', '${nestedPropName}', this.value)">
                                                <option value="string" ${nestedProp.items?.type === 'string' ? 'selected' : ''}>string</option>
                                                <option value="number" ${nestedProp.items?.type === 'number' ? 'selected' : ''}>number</option>
                                                <option value="integer" ${nestedProp.items?.type === 'integer' ? 'selected' : ''}>integer</option>
                                                <option value="boolean" ${nestedProp.items?.type === 'boolean' ? 'selected' : ''}>boolean</option>
                                                <option value="object" ${nestedProp.items?.type === 'object' ? 'selected' : ''}>object</option>
                                            </select>
                                        </div>
                                        ` : ''}
                                    </div>
                                    `;
                                }).join('')}
                                ${window.hasTypesFile ? `
                                <button class="btn btn-secondary btn-sm" style="margin-top: 12px;"
                                        onclick="openNestedGraphTypesModal(${index}, '${propName}')">
                                    <span class="material-icons">add</span> Add from ${window.typesName || 'types'}
                                </button>` : ''}
                            </div>
                        </div>
                        ` : propDef.type === 'object' ? `
                        <div class="form-group">
                            <label>Nested Properties</label>
                            <div style=" padding: 20px; background: var(--bg-color); border-radius: var(--radius-sm);">
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">No nested properties defined</div>
                                ${window.hasTypesFile ? `
                                <button class="btn btn-secondary btn-sm"
                                        onclick="openNestedGraphTypesModal(${index}, '${propName}')">
                                    <span class="material-icons">add</span> Add from ${window.typesName || 'types'}
                                </button>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        ${propDef.type === 'string' ? `
                        <div class="form-group">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" ${propDef.enum ? 'checked' : ''}
                                       onchange="toggleEnum(${index}, '${propName}', this.checked)"
                                       style="margin-right: 8px;">
                                Has Enum Values
                            </label>
                            ${propDef.enum ? `
                            <input class="form-control" value="${propDef.enum.join(', ')}"
                                   placeholder="Enter comma-separated values"
                                   onchange="updatePropertyEnum(${index}, '${propName}', this.value)">
                            ` : ''}
                        </div>
                        ` : ''}
                        </div>
                    </div>
                `;
            }

            editorContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 600;">Edit Tool: ${tool.name}</h2>
                    <button class="btn btn-danger btn-sm" onclick="deleteTool(${index})">Delete Tool</button>
                </div>

                <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 8px;">
                    <div class="form-group" style="flex: 1; min-width: 240px; margin-bottom: 0;">
                        <label>Tool Name</label>
                        <input class="form-control" id="toolName" value="${tool.name}"
                               onchange="updateToolField(${index}, 'name', this.value)">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 260px; margin-bottom: 0;">
                        <label>MCP Service</label>
                        <select class="form-control" id="mcpService"
                                onchange="updateMcpService(${index}, this.value)">
                            <option value="">-- Select MCP Service --</option>
                            ${window.mcpServices ? window.mcpServices.map(service => {
                                const currentService = typeof tool.mcp_service === 'object' ? tool.mcp_service?.name : tool.mcp_service;
                                return `<option value="${service}" ${currentService === service ? 'selected' : ''}>${service}</option>`;
                            }).join('') : ''}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="toolDescription"
                              onchange="updateToolField(${index}, 'description', this.value)">${tool.description}</textarea>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="margin: 0;">Input Schema Properties</label>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="expandAllProperties()" style="margin-right: 8px;">
                                â–¼ Expand All
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="collapseAllProperties()">
                                â–¶ Collapse All
                            </button>
                        </div>
                    </div>
                    <div class="properties-container">
                        ${propertiesHtml}
                        <button class="add-button" onclick="addProperty(${index})">
                            <span class="material-icons">add</span> Add Property
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="collapsible-header" onclick="toggleJsonView()" style="background: #f0f0f0; padding: 10px; border-radius: 6px; cursor: pointer;">
                        <span class="collapse-icon" id="json-collapse-icon" style="display: inline-block; margin-right: 8px;">â–¼</span>
                        <label style="margin: 0; cursor: pointer; font-weight: 600;">Raw JSON View</label>
                    </div>
                    <div class="json-viewer" id="json-viewer" style="margin-top: 10px;">
                        <pre>${JSON.stringify(tool, null, 2)}</pre>
                    </div>
                </div>
            `;
        }

        function updateToolField(index, field, value) {
            tools[index][field] = value;
            renderToolList();
        }

        function updateMcpService(index, value) {
            updateToolField(index, 'mcp_service', value);
            applySignatureDefaults(index, value);
            renderToolEditor(tools[index], index);
        }

        function updatePropertyField(index, propName, field, value) {
            if (!tools[index].inputSchema.properties[propName]) {
                tools[index].inputSchema.properties[propName] = {};
            }
            tools[index].inputSchema.properties[propName][field] = value;
        }

        function updatePropertyEnum(index, propName, value) {
            const enumValues = value.split(',').map(v => v.trim()).filter(v => v);
            tools[index].inputSchema.properties[propName].enum = enumValues;
        }

        function toggleEnum(index, propName, hasEnum) {
            if (hasEnum) {
                tools[index].inputSchema.properties[propName].enum = [];
            } else {
                delete tools[index].inputSchema.properties[propName].enum;
            }
            renderToolEditor(tools[index], index);
        }

        function toggleRequired(index, propName, isChecked) {
            if (!tools[index].inputSchema.required) {
                tools[index].inputSchema.required = [];
            }

            if (isChecked) {
                // Add to required if not already there
                if (!tools[index].inputSchema.required.includes(propName)) {
                    tools[index].inputSchema.required.push(propName);
                }
            } else {
                // Remove from required
                tools[index].inputSchema.required = tools[index].inputSchema.required.filter(r => r !== propName);
            }

            // Re-render to update the JSON view
            renderToolEditor(tools[index], index);
        }

        function parseDefaultValue(value, type) {
            if (value === '') return undefined;
            switch (type) {
                case 'integer':
                    return parseInt(value, 10);
                case 'number':
                    return parseFloat(value);
                case 'boolean':
                    return value === 'true' || value === true;
                default:
                    return value;
            }
        }

        function addProperty(index) {
            // Remove any existing property modal first
            const existingModal = document.getElementById('propertyModal');
            if (existingModal) {
                existingModal.parentElement.remove();
            }

            // Create modal for property selection
            const hasTypes = window.hasTypesFile || false;
            const typesName = window.typesName || 'types';
            const modalHtml = `
                <div id="propertyModal" class="modal show">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Add Property</h3>
                            <button onclick="closeModal('propertyModal')" class="close-btn">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Property Source</label>
                                <select id="propertySource" onchange="handlePropertySourceChange()" class="form-control">
                                    <option value="custom">Custom Property</option>
                                    ${hasTypes ? `<option value="graph_types">From ${typesName}.py</option>` : ''}
                                </select>
                            </div>

                            <div id="customPropertyDiv">
                                <div class="form-group">
                                    <label>Property Name</label>
                                    <input type="text" id="customPropName" class="form-control" placeholder="Enter property name">
                                </div>
                                <div class="form-group">
                                    <label>Property Type</label>
                                    <select id="customPropType" class="form-control">
                                        <option value="string">string</option>
                                        <option value="integer">integer</option>
                                        <option value="number">number</option>
                                        <option value="boolean">boolean</option>
                                        <option value="array">array</option>
                                        <option value="object">object</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" id="customPropDescription" class="form-control" placeholder="Property description">
                                </div>
                            </div>

                            <div id="graphTypesPropertyDiv" style="display: none;">
                                <div class="form-group">
                                    <label>Select Type (from outlook_types.py)</label>
                                    <select id="graphTypeClass" onchange="handleClassChange()" class="form-control">
                                        <option value="">-- Select Type --</option>
                                        <option value="FilterParams">FilterParams (Filter criteria)</option>
                                        <option value="ExcludeParams">ExcludeParams (Exclusion criteria)</option>
                                        <option value="SelectParams">SelectParams (Field selection)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="propertySelectionDiv" style="display: none;">
                                    <label>Select Properties to Add</label>
                                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;">
                                        <div id="propertyCheckboxList">
                                            <!-- Checkboxes will be populated here -->
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllProperties(true)">Select All</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllProperties(false)">Deselect All</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllRequired(true)">All Required</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllRequired(false)">All Optional</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button onclick="confirmAddProperty(${index})" class="btn btn-primary">Add Property</button>
                            <button onclick="closeModal('propertyModal')" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);

            // Initialize the property source view to show custom property fields by default
            handlePropertySourceChange();
        }

        function handlePropertySourceChange() {
            const source = document.getElementById('propertySource').value;
            document.getElementById('customPropertyDiv').style.display = source === 'custom' ? 'block' : 'none';
            document.getElementById('graphTypesPropertyDiv').style.display = source === 'graph_types' ? 'block' : 'none';
        }

        function handleClassChange() {
            const className = document.getElementById('graphTypeClass').value;
            const selectionDiv = document.getElementById('propertySelectionDiv');
            const checkboxList = document.getElementById('propertyCheckboxList');

            if (className && window.graphTypesProperties) {
                const properties = window.graphTypesProperties.properties_by_class[className] || [];

                // Generate checkboxes for each property
                let checkboxHtml = '';
                properties.forEach((prop, idx) => {
                    const propId = `prop_${className}_${idx}`;
                    const reqId = `req_${className}_${idx}`;
                    checkboxHtml += `
                        <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                            <input type="checkbox" id="${propId}" data-prop-name="${prop.name}"
                                   data-prop-type="${prop.type}" data-prop-desc="${prop.description || ''}"
                                   style="margin-right: 10px;">
                            <div style="flex-grow: 1;">
                                <label for="${propId}" style="margin: 0; cursor: pointer;">
                                    <strong>${prop.name}</strong>
                                    <span style="color: #666; font-size: 12px;">(${prop.type})</span>
                                    ${prop.description ? `<br><span style="color: #888; font-size: 11px;">${prop.description}</span>` : ''}
                                </label>
                            </div>
                            <div style="margin-left: 10px;">
                                <label style="margin: 0; font-size: 12px;">
                                    <input type="checkbox" id="${reqId}" style="margin-right: 5px;">Required
                                </label>
                            </div>
                        </div>
                    `;
                });

                checkboxList.innerHTML = checkboxHtml || '<div style="padding: 10px; text-align: center; color: #666;">No properties available</div>';
                selectionDiv.style.display = 'block';
            } else {
                selectionDiv.style.display = 'none';
            }
        }

        function selectAllProperties(select) {
            const checkboxes = document.querySelectorAll('#propertyCheckboxList input[type="checkbox"][id^="prop_"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function toggleAllRequired(required) {
            const checkboxes = document.querySelectorAll('#propertyCheckboxList input[type="checkbox"][id^="req_"]');
            checkboxes.forEach(cb => cb.checked = required);
        }

        function openNestedGraphTypesModal(toolIndex, propName) {
            nestedGraphTarget = {toolIndex, propName};

            const classSelect = document.getElementById('nestedGraphTypeClass');
            const selectionDiv = document.getElementById('nestedPropertySelectionDiv');
            const checkboxList = document.getElementById('nestedPropertyCheckboxList');

            classSelect.value = '';
            checkboxList.innerHTML = '';
            selectionDiv.style.display = 'none';

            populateGraphTypeOptions(classSelect);

            const parentProp = tools[toolIndex].inputSchema.properties[propName];
            if (parentProp && parentProp.baseModel) {
                classSelect.value = parentProp.baseModel;
                handleNestedGraphClassChange();
            }

            document.getElementById('nestedGraphTypesModal').classList.add('show');
        }

        function handleNestedGraphClassChange() {
            const className = document.getElementById('nestedGraphTypeClass').value;
            const selectionDiv = document.getElementById('nestedPropertySelectionDiv');
            const checkboxList = document.getElementById('nestedPropertyCheckboxList');

            if (className && window.graphTypesProperties) {
                const properties = window.graphTypesProperties.properties_by_class[className] || [];

                let checkboxHtml = '';
                properties.forEach((prop, idx) => {
                    const propId = `nested_prop_${className}_${idx}`;
                    const reqId = `nested_req_${className}_${idx}`;
                    checkboxHtml += `
                        <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                            <input type="checkbox" id="${propId}" data-prop-name="${prop.name}"
                                   data-prop-type="${prop.type}" data-prop-desc="${prop.description || ''}"
                                   style="margin-right: 10px;">
                            <div style="flex-grow: 1;">
                                <label for="${propId}" style="margin: 0; cursor: pointer;">
                                    <strong>${prop.name}</strong>
                                    <span style="color: #666; font-size: 12px;">(${prop.type})</span>
                                    ${prop.description ? `<br><span style="color: #888; font-size: 11px;">${prop.description}</span>` : ''}
                                </label>
                            </div>
                            <div style="margin-left: 10px;">
                                <label style="margin: 0; font-size: 12px;">
                                    <input type="checkbox" id="${reqId}" style="margin-right: 5px;">Required
                                </label>
                            </div>
                        </div>
                    `;
                });

                checkboxList.innerHTML = checkboxHtml || '<div style="padding: 10px; text-align: center; color: #666;">No properties available</div>';
                selectionDiv.style.display = 'block';
            } else {
                selectionDiv.style.display = 'none';
                checkboxList.innerHTML = '';
            }
        }

        function selectAllNestedProperties(select) {
            const checkboxes = document.querySelectorAll('#nestedPropertyCheckboxList input[type="checkbox"][id^="nested_prop_"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function toggleAllNestedRequired(required) {
            const checkboxes = document.querySelectorAll('#nestedPropertyCheckboxList input[type="checkbox"][id^="nested_req_"]');
            checkboxes.forEach(cb => cb.checked = required);
        }

        function confirmAddNestedGraphProperties() {
            if (!nestedGraphTarget) {
                closeModal('nestedGraphTypesModal');
                return;
            }

            const className = document.getElementById('nestedGraphTypeClass').value;
            const checkboxes = document.querySelectorAll('#nestedPropertyCheckboxList input[type="checkbox"][id^="nested_prop_"]:checked');

            if (!className) {
                showNotification('Please select a type from outlook_types.py', 'error');
                return;
            }

            if (checkboxes.length === 0) {
                showNotification('Please select at least one property', 'error');
                return;
            }

            const {toolIndex, propName} = nestedGraphTarget;
            const tool = tools[toolIndex];

            if (!tool.inputSchema.properties[propName]) {
                tool.inputSchema.properties[propName] = {type: 'object', properties: {}, required: []};
            }

            const parentProp = tool.inputSchema.properties[propName];
            parentProp.type = 'object';
            parentProp.properties = parentProp.properties || {};
            parentProp.required = parentProp.required || [];
            parentProp.baseModel = parentProp.baseModel || className;
            if (!parentProp.description) {
                parentProp.description = `${className} parameters`;
            }

            let addedCount = 0;
            checkboxes.forEach(cb => {
                const prop = cb.dataset;
                const idx = cb.id.split('_').pop();
                const isRequired = document.getElementById(`nested_req_${className}_${idx}`).checked;

                parentProp.properties[prop.propName] = {
                    type: mapToJsonSchemaType(prop.propType),
                    description: prop.propDesc || ''
                };

                if (isRequired && !parentProp.required.includes(prop.propName)) {
                    parentProp.required.push(prop.propName);
                }

                addedCount++;
            });

            closeModal('nestedGraphTypesModal');
            renderToolEditor(tool, toolIndex);
            showNotification(`${addedCount} nested properties added to "${propName}"`, 'success');
        }

        function confirmAddProperty(index) {
            const source = document.getElementById('propertySource').value;

            if (source === 'custom') {
                // Handle single custom property
                const propName = document.getElementById('customPropName').value;
                const propType = document.getElementById('customPropType').value;
                const propDescription = document.getElementById('customPropDescription').value;

                if (propName) {
                    if (!tools[index].inputSchema.properties) {
                        tools[index].inputSchema.properties = {};
                    }

                    // Check if property already exists
                    if (tools[index].inputSchema.properties[propName]) {
                        if (!confirm(`Property "${propName}" already exists. Do you want to overwrite it?`)) {
                            return;
                        }
                    }

                    // For custom properties, use simple type
                    const jsonType = mapToJsonSchemaType(propType);
                    tools[index].inputSchema.properties[propName] = {
                        type: jsonType,
                        description: propDescription
                    };

                    closeModal('propertyModal');
                    renderToolEditor(tools[index], index);
                    showNotification(`Property "${propName}" added successfully`, 'success');
                } else {
                    showNotification('Please enter a property name', 'error');
                }
            } else {
                // Handle multiple properties from graph_types
                const className = document.getElementById('graphTypeClass').value;
                const checkboxes = document.querySelectorAll('#propertyCheckboxList input[type="checkbox"][id^="prop_"]:checked');

                if (!className) {
                    showNotification('Please select a type from outlook_types.py', 'error');
                    return;
                }

                if (checkboxes.length === 0) {
                    showNotification('Please select at least one property', 'error');
                    return;
                }

                if (!tools[index].inputSchema.properties) {
                    tools[index].inputSchema.properties = {};
                }
                if (!tools[index].inputSchema.required) {
                    tools[index].inputSchema.required = [];
                }

                let addedCount = 0;
                const targetPropName = getTargetPropertyForGraphType(className, tools[index]);

                if (targetPropName) {
                    if (!tools[index].inputSchema.properties[targetPropName]) {
                        tools[index].inputSchema.properties[targetPropName] = {
                            type: 'object',
                            description: `${className} parameters`,
                            properties: {},
                            required: []
                        };
                    }

                    const targetProp = tools[index].inputSchema.properties[targetPropName];
                    targetProp.type = 'object';
                    targetProp.properties = targetProp.properties || {};
                    targetProp.required = targetProp.required || [];
                    targetProp.baseModel = className;
                    if (!targetProp.description) {
                        targetProp.description = `${className} parameters`;
                    }

                    checkboxes.forEach(checkbox => {
                        const propName = checkbox.dataset.propName;
                        const propType = checkbox.dataset.propType;
                        const propDesc = checkbox.dataset.propDesc;
                        const idx = checkbox.id.split('_').pop();
                        const isRequired = document.getElementById(`req_${className}_${idx}`).checked;

                        targetProp.properties[propName] = {
                            type: mapToJsonSchemaType(propType),
                            description: propDesc || ''
                        };

                        if (isRequired && !targetProp.required.includes(propName)) {
                            targetProp.required.push(propName);
                        }

                        addedCount++;
                    });
                } else {
                    // Fallback: add to top-level properties (legacy behavior)
                    checkboxes.forEach(checkbox => {
                        const propName = checkbox.dataset.propName;
                        const propType = checkbox.dataset.propType;
                        const propDesc = checkbox.dataset.propDesc;
                        const idx = checkbox.id.split('_').pop();
                        const isRequired = document.getElementById(`req_${className}_${idx}`).checked;

                        tools[index].inputSchema.properties[propName] = {
                            type: mapToJsonSchemaType(propType),
                            description: propDesc || ''
                        };

                        if (isRequired && !tools[index].inputSchema.required.includes(propName)) {
                            tools[index].inputSchema.required.push(propName);
                        }

                        addedCount++;
                    });
                }

                closeModal('propertyModal');
                renderToolEditor(tools[index], index);
                showNotification(`${addedCount} properties added successfully${targetPropName ? ` to "${targetPropName}"` : ''}`, 'success');
            }
        }

        function mapToJsonSchemaType(type) {
            // Map Python/graph_types types to JSON Schema types
            const typeMap = {
                'string': 'string',
                'str': 'string',
                'integer': 'integer',
                'int': 'integer',
                'number': 'number',
                'float': 'number',
                'boolean': 'boolean',
                'bool': 'boolean',
                'array': 'array',
                'object': 'object',
                'any': 'string'
            };
            return typeMap[type] || 'string';
        }

        function mapSignatureTypeToSchema(typeStr) {
            if (!typeStr) {
                return { type: 'string' };
            }

            let optional = false;
            let innerType = typeStr;

            if (typeStr.startsWith('Optional[')) {
                optional = true;
                innerType = typeStr.slice(9, -1);
            }

            if (innerType.startsWith('List[') || innerType.startsWith('list[')) {
                const itemType = innerType.slice(5, -1);
                const mapped = mapSignatureTypeToSchema(itemType);
                return {
                    type: 'array',
                    items: { type: mapped.type || 'string' },
                    optional
                };
            }

            const typeMap = {
                'str': 'string',
                'int': 'integer',
                'float': 'number',
                'bool': 'boolean',
                'Dict': 'object',
                'dict': 'object',
                'Any': 'string',
                'FilterParams': 'object',
                'ExcludeParams': 'object',
                'SelectParams': 'object'
            };

            return {
                type: typeMap[innerType] || 'object',
                description: ['FilterParams', 'ExcludeParams', 'SelectParams'].includes(innerType)
                    ? `${innerType} parameters`
                    : '',
                optional
            };
        }

        function applySignatureDefaults(index, serviceName) {
            if (!serviceName || !window.mcpServiceDetails) {
                return;
            }

            const detail = window.mcpServiceDetails.find(svc => svc.name === serviceName);
            if (!detail || !Array.isArray(detail.parameters)) {
                return;
            }

            const tool = tools[index];
            if (!tool.inputSchema) {
                tool.inputSchema = { type: 'object', properties: {}, required: [] };
            }

            const existingProps = Object.keys(tool.inputSchema.properties || {});
            if (existingProps.length > 0) {
                return; // avoid overriding when schema already exists
            }

            tool.inputSchema.type = 'object';
            tool.inputSchema.properties = {};
            tool.inputSchema.required = [];

            detail.parameters.forEach(param => {
                if (!param || param.name === 'self') {
                    return;
                }

                const schema = mapSignatureTypeToSchema(param.type);
                tool.inputSchema.properties[param.name] = {
                    type: schema.type || 'string',
                    description: schema.description || ''
                };

                const hasDefault = param.default !== null && param.default !== undefined;
                const isOptional = param.type && param.type.startsWith('Optional[');
                if (!hasDefault && !isOptional) {
                    if (!tool.inputSchema.required.includes(param.name)) {
                        tool.inputSchema.required.push(param.name);
                    }
                }
            });

            showNotification(`Input schema pre-filled from ${serviceName} signature`, 'success');
        }

        function getTargetPropertyForGraphType(className, tool) {
            const mapping = {
                'FilterParams': ['filter'],
                'ExcludeParams': ['exclude', 'client_filter'],
                'SelectParams': ['select']
            };

            const candidates = mapping[className];
            if (!candidates || candidates.length === 0) {
                return null;
            }

            // Prefer an existing property match
            for (const candidate of candidates) {
                if (tool.inputSchema.properties[candidate]) {
                    return candidate;
                }
            }

            // Otherwise, use the primary candidate to create a new object
            return candidates[0];
        }

        function removeProperty(index, propName) {
            if (confirm(`Remove property "${propName}"?`)) {
                delete tools[index].inputSchema.properties[propName];
                // Also remove from required if present
                if (tools[index].inputSchema.required) {
                    tools[index].inputSchema.required = tools[index].inputSchema.required.filter(r => r !== propName);
                }
                renderToolEditor(tools[index], index);
            }
        }

        function addNewTool() {
            const newTool = {
                name: 'new_tool_' + Date.now(),
                description: 'New tool description',
                mcp_service: '',  // Add mcp_service field
                inputSchema: {
                    type: 'object',
                    properties: {},
                    required: []
                }
            };
            tools.push(newTool);
            renderToolList();
            selectTool(tools.length - 1);
        }

        function deleteTool(index) {
            if (confirm(`Delete tool "${tools[index].name}"?`)) {
                const profileQuery = profileParam();
                fetch(`/api/tools/${index}${profileQuery}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message + (data.backup ? ` (Backup: ${data.backup})` : ''), 'success');
                        tools.splice(index, 1);
                        currentToolIndex = -1;
                        renderToolList();
                        document.getElementById('editorContent').innerHTML = `
                            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                                Select a tool from the left sidebar to edit
                            </div>
                        `;
                    } else {
                        showNotification(`Error deleting tool: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting tool:', error);
                    showNotification('Failed to delete tool', 'error');
                });
            }
        }

        function saveTools() {
            const profileQuery = profileParam();
            const saveProfile = originalProfile || 'default';
            fetch(`/api/tools${profileQuery}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tools)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Tools saved to "${saveProfile}"! Backup: ${data.backup}`, 'success');
                } else {
                    showNotification(`Error saving tools: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving tools:', error);
                showNotification('Failed to save tools', 'error');
            });
        }

        function validateTools() {
            const profileQuery = profileParam();
            fetch(`/api/tools/validate${profileQuery}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tools)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showNotification('Tools are valid!', 'success');
                } else {
                    showNotification(`Validation error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error validating tools:', error);
                showNotification('Failed to validate tools', 'error');
            });
        }

        function showBackups() {
            const profileQuery = profileParam();
            fetch(`/api/backups${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    const backupList = document.getElementById('backupList');
                    if (data.length === 0) {
                        backupList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No backups available</p>';
                    } else {
                        backupList.innerHTML = data.map(backup => `
                            <div class="backup-item">
                                <div class="backup-info">
                                    <div class="backup-name">${backup.filename}</div>
                                    <div class="backup-date">${new Date(backup.modified).toLocaleString()}</div>
                                </div>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="viewBackup('${backup.filename}')">View</button>
                                    <button class="btn btn-primary btn-sm" onclick="restoreBackup('${backup.filename}')">Restore</button>
                                </div>
                            </div>
                        `).join('');
                    }
                    document.getElementById('backupModal').classList.add('show');
                })
                .catch(error => {
                    console.error('Error loading backups:', error);
                    showNotification('Failed to load backups', 'error');
                });
        }

        function viewBackup(filename) {
            const profileQuery = profileParam();
            fetch(`/api/backups/${filename}${profileQuery}`)
                .then(response => response.json())
                .then(data => {
                    alert(JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    console.error('Error viewing backup:', error);
                    showNotification('Failed to view backup', 'error');
                });
        }

        function restoreBackup(filename) {
            if (confirm(`Restore backup from ${filename}? Current state will be backed up first.`)) {
                const profileQuery = profileParam();
                fetch(`/api/backups/${filename}/restore${profileQuery}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Backup restored successfully! Current state backed up as: ${data.current_backup}`, 'success');
                        closeModal('backupModal');
                        loadTools();
                    } else {
                        showNotification(`Error restoring backup: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error restoring backup:', error);
                    showNotification('Failed to restore backup', 'error');
                });
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (modalId === 'propertyModal') {
                    modal.parentElement.remove();
                } else {
                    modal.classList.remove('show');
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function togglePropertyCollapse(propId) {
            const content = document.getElementById(`content-${propId}`);
            const icon = document.getElementById(`icon-${propId}`);
            const header = document.getElementById(`header-${propId}`);

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = 'â–¼';
                header.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = 'â–¶';
                header.classList.remove('expanded');
            }
        }

        function toggleJsonView() {
            const viewer = document.getElementById('json-viewer');
            const icon = document.getElementById('json-collapse-icon');

            if (viewer.classList.contains('collapsed')) {
                viewer.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = 'â–¼';
            } else {
                viewer.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = 'â–¶';
            }
        }

        function expandAllProperties() {
            const allProperties = document.querySelectorAll('.property-collapse-content');
            const allIcons = document.querySelectorAll('.property-collapse-header .collapse-icon');
            const allHeaders = document.querySelectorAll('.property-collapse-header');

            allProperties.forEach(prop => prop.classList.remove('collapsed'));
            allIcons.forEach(icon => { icon.classList.remove('collapsed'); icon.textContent = 'â–¼'; });
            allHeaders.forEach(header => header.classList.add('expanded'));
        }

        function collapseAllProperties() {
            const allProperties = document.querySelectorAll('.property-collapse-content');
            const allIcons = document.querySelectorAll('.property-collapse-header .collapse-icon');
            const allHeaders = document.querySelectorAll('.property-collapse-header');

            allProperties.forEach(prop => prop.classList.add('collapsed'));
            allIcons.forEach(icon => { icon.classList.add('collapsed'); icon.textContent = 'â–¶'; });
            allHeaders.forEach(header => header.classList.remove('expanded'));
        }
    </script>
</body>
</html>
