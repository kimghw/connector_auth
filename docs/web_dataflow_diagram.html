<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP 웹에디터 데이터 흐름 다이어그램</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2rem;
        }
        h2 {
            color: #00d4ff;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #00d4ff;
        }
        h3 {
            color: #7dd3fc;
            margin: 20px 0 10px 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .diagram-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .mermaid {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .nav {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
        }
        .nav a {
            display: block;
            color: #7dd3fc;
            text-decoration: none;
            padding: 5px 0;
            font-size: 0.9rem;
        }
        .nav a:hover {
            color: #00d4ff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px;
            text-align: left;
        }
        th {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            color: #7dd3fc;
        }
        .phase-badge {
            display: inline-block;
            background: #00d4ff;
            color: #1a1a2e;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="nav">
        <strong style="color:#00d4ff">목차</strong>
        <a href="#architecture">1. 전체 아키텍처</a>
        <a href="#phase1">2. Phase 1: 데이터 수집</a>
        <a href="#phase2">3. Phase 2: 웹 UI 편집</a>
        <a href="#phase3">4. Phase 3: Save</a>
        <a href="#phase4">5. Phase 4: Generate</a>
        <a href="#mapping">6. 파라미터 매핑</a>
        <a href="#handler">7. 핸들러 구조</a>
        <a href="#summary">8. 저장 위치 요약</a>
    </div>

    <div class="container">
        <h1>MCP 웹에디터 데이터 흐름 다이어그램</h1>

        <!-- 1. 전체 아키텍처 -->
        <div class="diagram-section" id="architecture">
            <h2>1. 전체 시스템 아키텍처</h2>
            <div class="mermaid">
flowchart TB
    subgraph Sources["데이터 소스 (Source Files)"]
        S1["@mcp_service<br/>데코레이터"]
        S2["tool_definition_<br/>templates.py"]
        S3["tool_internal_<br/>args.json"]
    end

    subgraph Editor["웹에디터 (tool_editor_web.py)"]
        E1["AST Scanner<br/>(fallback)"]
        E2["JSON Registry<br/>(primary)"]
        E3["Internal Args<br/>Loader"]
        UI["웹 UI (tool_editor.html)<br/>• Tool 목록 표시/편집<br/>• 속성 추가/삭제/수정<br/>• Internal toggle 설정"]
    end

    subgraph Save["저장 & 생성"]
        API1["POST /api/tools/save-all"]
        API2["POST /api/server/generate"]
    end

    subgraph Generate["서버 생성 (Jinja2)"]
        IN["Input Files<br/>• registry.json<br/>• templates.py<br/>• internal_args.json<br/>• *.jinja2"]
        OUT["Output Files<br/>• server_rest.py<br/>• server_stdio.py<br/>• server_stream.py<br/>• tool_definitions.py"]
    end

    S1 --> E1
    S2 --> E2
    S3 --> E3
    E1 --> UI
    E2 --> UI
    E3 --> UI
    UI --> API1
    UI --> API2
    API1 --> IN
    API2 --> IN
    IN --> OUT

    style Sources fill:#2d3748,stroke:#4299e1,color:#fff
    style Editor fill:#1a365d,stroke:#4299e1,color:#fff
    style Save fill:#2c5282,stroke:#4299e1,color:#fff
    style Generate fill:#2b6cb0,stroke:#4299e1,color:#fff
            </div>
        </div>

        <!-- 2. Phase 1 -->
        <div class="diagram-section" id="phase1">
            <h2><span class="phase-badge">Phase 1</span> 데이터 수집 (웹에디터 시작)</h2>
            <div class="mermaid">
flowchart TD
    subgraph Input["입력 소스"]
        PY["Python 파일<br/>(@mcp_service 데코레이터)"]
        TPL["tool_definition_<br/>templates.py"]
        JSON["tool_internal_<br/>args.json"]
    end

    subgraph Process["파싱 프로세스"]
        AST["AST Scanner<br/>(NodeVisitor)"]
        IMP["importlib<br/>.exec_module"]
        LOAD["JSON.load()"]
    end

    subgraph Memory["메모리 저장소"]
        REG["registry_{server}.json"]
        TOOLS["MCP_TOOLS 리스트"]
        ARGS["internal_args dict"]
        SVC["services dict"]
    end

    PY --> AST --> REG --> SVC
    TPL --> IMP --> TOOLS
    JSON --> LOAD --> ARGS

    style Input fill:#3c366b,stroke:#805ad5,color:#fff
    style Process fill:#553c9a,stroke:#805ad5,color:#fff
    style Memory fill:#6b46c1,stroke:#805ad5,color:#fff
            </div>
        </div>

        <!-- 3. Phase 2 -->
        <div class="diagram-section" id="phase2">
            <h2><span class="phase-badge">Phase 2</span> 웹 UI 편집</h2>
            <div class="mermaid">
flowchart LR
    subgraph Data["로드된 데이터"]
        T["tools[]<br/>• name<br/>• description<br/>• inputSchema"]
        M["mcp_service<br/>• name<br/>• parameters<br/>• signature"]
        I["internal_args<br/>• type<br/>• targetParam<br/>• original_schema"]
    end

    subgraph UI["웹에디터 UI"]
        LIST["Tool 목록"]
        EDIT["속성 편집"]
        TOGGLE["Internal Toggle"]
    end

    T --> LIST
    M --> EDIT
    I --> TOGGLE

    style Data fill:#22543d,stroke:#48bb78,color:#fff
    style UI fill:#276749,stroke:#48bb78,color:#fff
            </div>
        </div>

        <!-- 4. Phase 3 -->
        <div class="diagram-section" id="phase3">
            <h2><span class="phase-badge">Phase 3</span> Save 시 데이터 분리</h2>
            <div class="mermaid">
flowchart TD
    SAVE["웹에디터 Save 버튼"]

    subgraph Output["분리 저장"]
        DEF["tool_definitions.py<br/><br/>• name<br/>• description<br/>• inputSchema (clean)<br/><br/>용도: Claude/OpenAI API"]
        TPL["tool_definition_templates.py<br/><br/>• name, description<br/>• inputSchema<br/>• mcp_service<br/>• mcp_service_factors<br/><br/>용도: 서버 생성 템플릿"]
        INT["tool_internal_args.json<br/><br/>• Internal 파라미터<br/>• targetParam 매핑<br/>• original_schema<br/><br/>용도: 런타임 주입"]
    end

    SAVE --> DEF
    SAVE --> TPL
    SAVE --> INT

    style SAVE fill:#c53030,stroke:#fc8181,color:#fff
    style Output fill:#742a2a,stroke:#fc8181,color:#fff
            </div>
        </div>

        <!-- 5. Phase 4 -->
        <div class="diagram-section" id="phase4">
            <h2><span class="phase-badge">Phase 4</span> Generate Server</h2>
            <div class="mermaid">
flowchart TD
    GEN["generate_universal_server.py<br/>prepare_context()"]

    subgraph Context["Context 구조"]
        CTX["server_name: 'outlook'<br/>protocol_type: 'rest' | 'stdio' | 'stream'<br/>services: { 서비스 라우팅 정보 }<br/>tools: [ 도구별 핸들러 정보 ]<br/>param_types: [ Pydantic 타입 ]<br/>type_info: { import 경로 }"]
    end

    subgraph Templates["Jinja2 템플릿"]
        T1["REST Template"]
        T2["STDIO Template"]
        T3["Stream Template"]
    end

    subgraph Output["생성 결과"]
        O1["server_rest.py"]
        O2["server_stdio.py"]
        O3["server_stream.py"]
    end

    GEN --> CTX
    CTX --> T1 --> O1
    CTX --> T2 --> O2
    CTX --> T3 --> O3

    style GEN fill:#2c7a7b,stroke:#4fd1c5,color:#fff
    style Context fill:#234e52,stroke:#4fd1c5,color:#fff
    style Templates fill:#285e61,stroke:#4fd1c5,color:#fff
    style Output fill:#319795,stroke:#4fd1c5,color:#fff
            </div>
        </div>

        <!-- 6. 파라미터 매핑 -->
        <div class="diagram-section" id="mapping">
            <h2>6. 파라미터 매핑 다이어그램</h2>

            <h3>targetParam 매핑 (inputSchema)</h3>
            <div class="mermaid">
flowchart LR
    subgraph LLM["LLM이 보는 이름"]
        A["'DatePeriodFilter'<br/>(Schema Property)"]
    end

    subgraph Method["실제 서비스 메서드"]
        B["'filter_params'<br/>(메서드 파라미터)"]
    end

    A -->|"targetParam"| B

    style LLM fill:#4c1d95,stroke:#a78bfa,color:#fff
    style Method fill:#5b21b6,stroke:#a78bfa,color:#fff
            </div>

            <h3>Internal Args 매핑</h3>
            <div class="mermaid">
flowchart LR
    subgraph Internal["tool_internal_args.json"]
        C["'select'<br/>(Internal arg 이름)"]
    end

    subgraph Method2["실제 서비스 메서드"]
        D["'select_params'<br/>(메서드 파라미터)"]
    end

    C -->|"targetParam"| D

    style Internal fill:#7c2d12,stroke:#fb923c,color:#fff
    style Method2 fill:#9a3412,stroke:#fb923c,color:#fff
            </div>
        </div>

        <!-- 7. 핸들러 구조 -->
        <div class="diagram-section" id="handler">
            <h2>7. 생성된 핸들러 구조</h2>
            <div class="mermaid">
flowchart TD
    HANDLER["async def handle_mail_list_period(args)"]

    subgraph Step1["Step 1: inputSchema 파라미터 추출"]
        S1A["DatePeriodFilter_raw = args.get('DatePeriodFilter')"]
        S1B["filter_params = FilterParams(**DatePeriodFilter_raw)"]
    end

    subgraph Step2["Step 2: Internal args 빌드"]
        S2A["select_params = build_internal_param(<br/>'mail_list_period', 'select')"]
    end

    subgraph Step3["Step 3: 서비스 메서드 호출"]
        S3A["return await mail_service.query_mail_list(<br/>filter_params=filter_params,<br/>select_params=select_params)"]
    end

    HANDLER --> Step1
    Step1 --> S1A --> S1B
    S1B --> Step2
    Step2 --> S2A
    S2A --> Step3
    Step3 --> S3A

    style HANDLER fill:#065f46,stroke:#34d399,color:#fff
    style Step1 fill:#047857,stroke:#34d399,color:#fff
    style Step2 fill:#059669,stroke:#34d399,color:#fff
    style Step3 fill:#10b981,stroke:#34d399,color:#fff
            </div>
        </div>

        <!-- 8. 전체 데이터 변환 흐름 -->
        <div class="diagram-section" id="summary">
            <h2>8. 전체 데이터 변환 흐름</h2>
            <div class="mermaid">
flowchart LR
    subgraph Source["소스코드"]
        A1["@mcp_service"]
        A2["outlook_service.py"]
        A3["outlook_types.py"]
        A4["(웹에서 편집)"]
    end

    subgraph Editor["웹에디터"]
        B1["registry.json"]
        B2["mcp_service.parameters"]
        B3["inputSchema.baseModel"]
        B4["tool_internal_args.json"]
    end

    subgraph Server["생성된 서버"]
        C1["import 경로"]
        C2["핸들러 서명"]
        C3["Pydantic 변환"]
        C4["build_internal_param()"]
    end

    A1 --> B1 --> C1
    A2 --> B2 --> C2
    A3 --> B3 --> C3
    A4 --> B4 --> C4

    style Source fill:#1e3a5f,stroke:#60a5fa,color:#fff
    style Editor fill:#1e40af,stroke:#60a5fa,color:#fff
    style Server fill:#2563eb,stroke:#60a5fa,color:#fff
            </div>

            <h2>핵심 저장 위치 요약</h2>
            <table>
                <thead>
                    <tr>
                        <th>데이터</th>
                        <th>소스</th>
                        <th>파싱 방법</th>
                        <th>저장 위치</th>
                        <th>용도</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>클래스/메서드 정보</td>
                        <td><code>@mcp_service</code> 데코레이터</td>
                        <td>AST NodeVisitor</td>
                        <td><code>registry_{server}.json</code></td>
                        <td>서비스 라우팅</td>
                    </tr>
                    <tr>
                        <td>파라미터 타입/기본값</td>
                        <td>함수 시그니처</td>
                        <td><code>ast.unparse()</code></td>
                        <td><code>registry_{server}.json</code></td>
                        <td>타입 검증</td>
                    </tr>
                    <tr>
                        <td>LLM용 스키마</td>
                        <td>웹에디터 편집</td>
                        <td>JSON 직렬화</td>
                        <td><code>tool_definition_templates.py</code></td>
                        <td>Claude API</td>
                    </tr>
                    <tr>
                        <td>targetParam 매핑</td>
                        <td>웹에디터 설정</td>
                        <td>inputSchema 속성</td>
                        <td><code>tool_definition_templates.py</code></td>
                        <td>파라미터 변환</td>
                    </tr>
                    <tr>
                        <td>Internal 파라미터</td>
                        <td>웹에디터 토글</td>
                        <td>JSON 직렬화</td>
                        <td><code>tool_internal_args.json</code></td>
                        <td>런타임 주입</td>
                    </tr>
                    <tr>
                        <td>클린 도구 정의</td>
                        <td>Save 시 생성</td>
                        <td>mcp_service 제거</td>
                        <td><code>tool_definitions.py</code></td>
                        <td>프로덕션 API</td>
                    </tr>
                </tbody>
            </table>

            <h2>파일 경로 참조</h2>
            <table>
                <thead>
                    <tr>
                        <th>구분</th>
                        <th>경로</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>웹에디터</td>
                        <td><code>mcp_editor/tool_editor_web.py</code></td>
                    </tr>
                    <tr>
                        <td>레지스트리</td>
                        <td><code>mcp_editor/mcp_service_registry/registry_{server}.json</code></td>
                    </tr>
                    <tr>
                        <td>템플릿 정의</td>
                        <td><code>mcp_editor/mcp_{server}/tool_definition_templates.py</code></td>
                    </tr>
                    <tr>
                        <td>Internal Args</td>
                        <td><code>mcp_editor/mcp_{server}/tool_internal_args.json</code></td>
                    </tr>
                    <tr>
                        <td>서버 생성</td>
                        <td><code>jinja/generate_universal_server.py</code></td>
                    </tr>
                    <tr>
                        <td>Jinja2 템플릿</td>
                        <td><code>jinja/universal_server_template.jinja2</code></td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
